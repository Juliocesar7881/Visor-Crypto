<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visor Crypto</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Visualizador de criptomoedas em tempo real com preços, notícias e análises">
    <meta name="theme-color" content="#58a6ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Visor Crypto">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230d1117'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='%2358a6ff'>₿</text></svg>">
    

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-elevated: #22222e;
            --accent-blue: #6366f1;
            --accent-blue-glow: rgba(99, 102, 241, 0.4);
            --accent-green: #22c55e;
            --accent-green-glow: rgba(34, 197, 94, 0.3);
            --accent-red: #ef4444;
            --accent-red-glow: rgba(239, 68, 68, 0.3);
            --accent-yellow: #eab308;
            --accent-purple: #a855f7;
            --accent-cyan: #06b6d4;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-visible: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(26, 26, 36, 0.8);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.15);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-visible); border-radius: 4px; }

        .mobile-frame {
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background: var(--bg-primary);
        }

        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px 20px;
            padding-top: calc(env(safe-area-inset-top, 20px) + 16px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .header-brand-img {
            height: 80px;
            width: auto;
            object-fit: contain;
            filter: drop-shadow(0 2px 8px rgba(99, 102, 241, 0.3));
        }

        /* Chart Modal */
        .chart-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .chart-modal.active {
            display: block;
        }

        .chart-modal-content {
            max-width: 430px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chart-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            padding-top: calc(env(safe-area-inset-top, 20px) + 16px);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
        }

        .chart-modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .chart-modal-close:hover {
            background: var(--accent-blue);
        }

        .chart-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chart-header-info img {
            width: 36px;
            height: 36px;
            border-radius: 10px;
        }

        .chart-header-name {
            font-size: 16px;
            font-weight: 700;
        }

        .chart-header-price {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .chart-modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .chart-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .chart-period-filters {
            display: flex;
            gap: 6px;
            justify-content: center;
        }

        .chart-period-btn {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 55px;
            text-align: center;
        }

        .chart-period-btn:hover {
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        .chart-period-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
            box-shadow: 0 4px 15px var(--accent-blue-glow);
        }

        .chart-type-toggle {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .chart-type-btn {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-type-btn:hover {
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        .chart-type-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
            box-shadow: 0 4px 15px var(--accent-blue-glow);
        }

        .chart-container {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--border-subtle);
            margin-bottom: 20px;
            min-height: 300px;
            position: relative;
        }

        .chart-canvas {
            width: 100%;
            height: 280px;
        }

        .chart-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .chart-stat-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border-subtle);
        }

        .chart-stat-value {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .chart-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* News Modal */
        .news-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .news-modal.active {
            display: block;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .news-modal-content {
            max-width: 430px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .news-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            padding-top: calc(env(safe-area-inset-top, 20px) + 16px);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
        }

        .news-modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .news-modal-close:hover {
            background: var(--accent-blue);
        }

        .news-modal-header-title {
            font-size: 16px;
            font-weight: 700;
        }

        .news-modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .news-modal-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
            position: relative;
        }

        .news-modal-image i {
            font-size: 60px;
            color: var(--accent-blue);
            opacity: 0.5;
        }

        .news-modal-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .news-modal-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .news-modal-source {
            padding: 6px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .news-modal-sentiment {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .news-modal-sentiment.positive {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }

        .news-modal-sentiment.negative {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .news-modal-sentiment.neutral {
            background: rgba(234, 179, 8, 0.15);
            color: var(--accent-yellow);
        }

        .news-modal-title {
            font-size: 22px;
            font-weight: 800;
            line-height: 1.4;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .news-modal-summary {
            font-size: 15px;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 16px;
            border-left: 3px solid var(--accent-blue);
        }

        .news-modal-time {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 13px;
            margin-bottom: 24px;
        }

        .news-modal-time i {
            color: var(--accent-blue);
        }

        .news-modal-button {
            width: 100%;
            padding: 18px 24px;
            background: linear-gradient(135deg, var(--accent-blue), #4f46e5);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px var(--accent-blue-glow);
        }

        .news-modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--accent-blue-glow);
        }

        .news-modal-button:active {
            transform: translateY(0);
        }

        /* Event Detail Modal */
        .event-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .event-detail-modal.active {
            display: block;
        }

        .event-detail-modal-content {
            max-width: 430px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .event-detail-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            padding-top: calc(env(safe-area-inset-top, 20px) + 16px);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
        }

        .event-detail-modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .event-detail-modal-close:hover {
            background: var(--accent-blue);
        }

        .event-detail-modal-header-title {
            font-size: 16px;
            font-weight: 700;
        }

        .event-detail-modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .event-detail-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated));
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border-subtle);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .event-detail-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
        }

        .event-detail-date {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            background: var(--bg-secondary);
            padding: 16px 24px;
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .event-detail-day {
            font-size: 32px;
            font-weight: 900;
            line-height: 1;
        }

        .event-detail-month {
            font-size: 14px;
            color: var(--accent-blue);
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .event-detail-title {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .event-detail-country {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .event-detail-impact {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .event-detail-impact.high {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .event-detail-impact.medium {
            background: rgba(234, 179, 8, 0.15);
            color: var(--accent-yellow);
        }

        .event-detail-impact.low {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }

        .event-detail-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 16px;
            border: 1px solid var(--border-subtle);
        }

        .event-detail-section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .event-detail-description,
        .event-detail-market-impact,
        .event-detail-crypto-impact {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Content */
        .content {
            padding: 16px;
            padding-bottom: 100px;
            overflow-y: auto;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            border-color: var(--border-visible);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .card-title i { 
            color: var(--accent-blue);
            font-size: 16px;
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .quick-stat {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }

        .quick-stat:hover {
            transform: translateY(-2px);
            border-color: var(--accent-blue);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
        }

        .quick-stat-value { 
            font-size: 22px; 
            font-weight: 800; 
            margin-bottom: 4px;
            background: linear-gradient(135deg, #fff, #e4e4e7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .quick-stat-label { 
            font-size: 11px; 
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* AI Card - Premium Style */
        .ai-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated));
            border: 1px solid var(--accent-blue);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-glow);
        }

        .ai-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple), var(--accent-cyan));
        }

        .ai-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }

        .ai-sentiment {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border-radius: 14px;
            margin-bottom: 16px;
            border: 1px solid var(--border-subtle);
        }

        .ai-sentiment-icon { 
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .ai-sentiment-icon.bullish {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            color: var(--accent-green);
        }

        .ai-sentiment-icon.bearish {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            color: var(--accent-red);
        }

        .ai-sentiment-icon.neutral {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(234, 179, 8, 0.1));
            color: var(--accent-yellow);
        }

        .ai-sentiment-value { font-size: 20px; font-weight: 800; }

        .ai-recommendation { margin-bottom: 16px; }
        .ai-rec-title {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ai-rec-content {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .ai-picks { display: grid; gap: 10px; }

        .ai-pick {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px;
            background: rgba(0,0,0,0.25);
            border-radius: 14px;
            border-left: 3px solid;
            transition: all 0.3s ease;
            border: 1px solid var(--border-subtle);
            border-left-width: 3px;
        }

        .ai-pick:hover {
            transform: translateX(4px);
            background: rgba(0,0,0,0.35);
        }

        .ai-pick.strong-buy { border-left-color: var(--accent-green); }
        .ai-pick.buy { border-left-color: #4ade80; }
        .ai-pick.hold { border-left-color: var(--accent-yellow); }
        .ai-pick.sell { border-left-color: var(--accent-red); }

        .ai-pick-info { flex: 1; }
        .ai-pick-symbol { font-weight: 700; font-size: 14px; }
        .ai-pick-price { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .ai-pick-allocation { text-align: right; }
        .ai-pick-change { font-size: 11px; }

        .pnl-positive { color: var(--accent-green); }
        .pnl-negative { color: var(--accent-red); }

        /* Ticker Items */
        .ticker-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .ticker-item:hover {
            transform: translateX(4px);
            border-color: var(--accent-blue);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.1);
        }

        .ticker-item:active {
            transform: scale(0.98);
        }

        .ticker-item:last-child { margin-bottom: 0; }
        .ticker-item.flash-green { 
            background: rgba(34, 197, 94, 0.15);
            border-color: var(--accent-green);
        }
        .ticker-item.flash-red { 
            background: rgba(239, 68, 68, 0.15);
            border-color: var(--accent-red);
        }

        .ticker-info { display: flex; align-items: center; gap: 12px; }
        
        .ticker-icon-img {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: var(--shadow-sm);
        }

        .ticker-name { font-weight: 700; font-size: 14px; }
        .ticker-pair { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .ticker-price { text-align: right; }
        .ticker-current { font-weight: 800; font-size: 16px; }
        .ticker-change { 
            font-size: 13px; 
            font-weight: 600;
            margin-top: 2px;
        }

        /* News Styles */
        .news-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .news-filters::-webkit-scrollbar { display: none; }

        .news-filter {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .news-filter:hover {
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        .news-filter.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
            box-shadow: 0 4px 15px var(--accent-blue-glow);
        }

        .news-item {
            padding: 16px;
            background: var(--bg-card);
            border-radius: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .news-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
        }

        .news-item.positive::before { background: var(--accent-green); }
        .news-item.negative::before { background: var(--accent-red); }
        .news-item.neutral::before { background: var(--accent-yellow); }

        .news-item:hover {
            transform: translateY(-2px);
            border-color: var(--border-visible);
            box-shadow: var(--shadow-md);
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 10px;
        }

        .news-sentiment {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .news-sentiment.positive { 
            background: rgba(34, 197, 94, 0.15); 
            color: var(--accent-green);
        }
        .news-sentiment.negative { 
            background: rgba(239, 68, 68, 0.15); 
            color: var(--accent-red);
        }
        .news-sentiment.neutral { 
            background: rgba(234, 179, 8, 0.15); 
            color: var(--accent-yellow);
        }

        .news-title {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.5;
            flex: 1;
            color: var(--text-primary);
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--text-muted);
        }

        .news-source { 
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .news-time { 
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Combined Analysis Card - Order Book + Moving Averages */
        .analysis-combined {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .analysis-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .analysis-tab {
            flex: 1;
            padding: 14px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .analysis-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: var(--accent-blue);
            transition: width 0.3s ease;
        }

        .analysis-tab.active {
            color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.05);
        }

        .analysis-tab.active::after {
            width: 60%;
        }

        .analysis-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.02);
        }

        .analysis-content {
            padding: 16px;
        }

        .analysis-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .analysis-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Order Book */
        .orderbook {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .orderbook-side { 
            padding: 14px; 
            border-radius: 14px;
            border: 1px solid var(--border-subtle);
        }
        
        .orderbook-bids { 
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(34, 197, 94, 0.02));
        }
        .orderbook-asks { 
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.02));
        }

        .orderbook-title {
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .orderbook-bids .orderbook-title { color: var(--accent-green); }
        .orderbook-asks .orderbook-title { color: var(--accent-red); }

        .orderbook-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 4px 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            transition: background 0.2s ease;
        }

        .orderbook-row:hover {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
        }

        .orderbook-bids .orderbook-row { color: var(--accent-green); }
        .orderbook-asks .orderbook-row { color: var(--accent-red); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-box {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .stat-value { 
            font-size: 18px; 
            font-weight: 800; 
            margin-bottom: 4px;
        }
        .stat-label { 
            font-size: 10px; 
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-change { 
            font-size: 12px; 
            font-weight: 600; 
            margin: 4px 0;
        }

        /* Moving Averages */
        .ma-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .ma-item {
            background: var(--bg-secondary);
            padding: 14px;
            border-radius: 14px;
            text-align: center;
            border: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }

        .ma-item:hover {
            border-color: var(--accent-blue);
            transform: scale(1.02);
        }

        .ma-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ma-value {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .ma-signal {
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .ma-signal.buy {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }
        .ma-signal.sell {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }
        .ma-signal.neutral {
            background: rgba(234, 179, 8, 0.15);
            color: var(--accent-yellow);
        }

        .ma-summary {
            background: var(--bg-secondary);
            padding: 14px;
            border-radius: 14px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--border-subtle);
        }

        /* Fear Greed Meter */
        .fear-greed-meter {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-md);
        }

        .meter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .meter-title { 
            font-size: 14px; 
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .meter-value { 
            font-size: 28px; 
            font-weight: 900;
            background: linear-gradient(135deg, #fff, #a1a1aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .meter-bar {
            height: 10px;
            background: linear-gradient(to right, #ef4444, #f97316, #eab308, #84cc16, #22c55e);
            border-radius: 10px;
            position: relative;
            margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .meter-indicator {
            position: absolute;
            top: -5px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            border: 3px solid var(--bg-primary);
            transform: translateX(-50%);
            transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* External Links */
        .external-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 14px;
            text-decoration: none;
            color: var(--text-primary);
            margin-bottom: 10px;
            border: 1px solid var(--border-subtle);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .external-link:hover {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.08);
            transform: translateX(4px);
        }

        .external-link i { 
            font-size: 18px; 
            color: var(--accent-blue); 
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
        }
        
        .external-link-text { flex: 1; min-width: 0; }
        .external-link-title { font-weight: 700; font-size: 13px; }
        .external-link-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 14px;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item:hover {
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--accent-blue);
        }

        .nav-item.active i {
            transform: scale(1.1);
        }

        .nav-item i { 
            font-size: 22px;
            transition: transform 0.3s ease;
        }
        .nav-item span { 
            font-size: 10px; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .section { 
            display: none;
            animation: fadeInSection 0.4s ease;
        }
        .section.active { display: block; }

        @keyframes fadeInSection {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Macro Section Styles */
        #macro {
            padding: 0 8px;
            padding-bottom: 20px;
        }

        #macro .card {
            margin-left: 0;
            margin-right: 0;
        }

        #macro .card-header {
            padding: 0 4px;
        }

        #macro .card:last-child {
            margin-bottom: 0;
        }

        .macro-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 4px;
            margin-bottom: 16px;
            margin-top: 0;
            gap: 4px;
        }

        .macro-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .macro-tab i {
            font-size: 16px;
        }

        .macro-tab.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 4px 15px var(--accent-blue-glow);
        }

        .macro-tab:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .macro-panel {
            display: none;
            animation: fadeIn 0.3s ease;
            padding: 0 2px;
            padding-bottom: 10px;
        }

        .macro-panel.active {
            display: block;
        }

        /* Fed Watch Styles */
        .fed-rate-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated));
            border-radius: 20px;
            padding: 18px;
            margin-bottom: 16px;
            border: 1px solid var(--border-subtle);
            position: relative;
            overflow: hidden;
        }

        .fed-rate-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
        }

        .fed-current-rate {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .fed-rate-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fed-rate-value {
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(135deg, #fff, #a1a1aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .fed-next-meeting {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .fed-next-meeting i {
            color: var(--accent-blue);
        }

        .fed-probabilities {
            display: grid;
            gap: 12px;
        }

        .fed-prob-item {
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid var(--border-subtle);
        }

        .fed-prob-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .fed-prob-action {
            font-size: 13px;
            font-weight: 700;
        }

        .fed-prob-action.cut {
            color: var(--accent-green);
        }

        .fed-prob-action.hold {
            color: var(--accent-yellow);
        }

        .fed-prob-action.hike {
            color: var(--accent-red);
        }

        .fed-prob-percent {
            font-size: 20px;
            font-weight: 800;
        }

        .fed-prob-bar {
            height: 8px;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
        }

        .fed-prob-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.5s ease;
        }

        .fed-prob-fill.cut {
            background: linear-gradient(90deg, var(--accent-green), #4ade80);
        }

        .fed-prob-fill.hold {
            background: linear-gradient(90deg, var(--accent-yellow), #fcd34d);
        }

        .fed-prob-fill.hike {
            background: linear-gradient(90deg, var(--accent-red), #f87171);
        }

        /* Economic Calendar */
        .calendar-event {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid var(--border-subtle);
            display: flex;
            gap: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .calendar-event:hover {
            border-color: var(--accent-blue);
            transform: translateX(4px);
        }

        .calendar-event:active {
            transform: scale(0.98);
        }

        .calendar-date {
            min-width: 50px;
            text-align: center;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .calendar-day {
            font-size: 20px;
            font-weight: 800;
            line-height: 1;
        }

        .calendar-month {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .calendar-info {
            flex: 1;
        }

        .calendar-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .calendar-country {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .calendar-impact {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            align-self: flex-start;
        }

        .calendar-impact.high {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .calendar-impact.medium {
            background: rgba(234, 179, 8, 0.15);
            color: var(--accent-yellow);
        }

        .calendar-impact.low {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }

        /* Market Indicators */
        .market-indicator {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .indicator-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .indicator-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .indicator-icon.vix {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            color: var(--accent-red);
        }

        .indicator-icon.dxy {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            color: var(--accent-green);
        }

        .indicator-icon.gold {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(234, 179, 8, 0.1));
            color: var(--accent-yellow);
        }

        .indicator-icon.oil {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.1));
            color: var(--accent-blue);
        }

        .indicator-icon.sp500 {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0.1));
            color: var(--accent-purple);
        }

        .indicator-name {
            font-size: 14px;
            font-weight: 700;
        }

        .indicator-desc {
            font-size: 11px;
            color: var(--text-muted);
        }

        .indicator-value {
            text-align: right;
        }

        .indicator-price {
            font-size: 18px;
            font-weight: 800;
        }

        .indicator-change {
            font-size: 12px;
            font-weight: 600;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px; 
            height: 40px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Crypto Dropdown */
        .crypto-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-selected {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 600;
        }

        .dropdown-selected:hover {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.08);
        }

        .dropdown-selected-icon {
            font-size: 18px;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 8px;
            display: none;
            z-index: 1000;
            max-height: 320px;
            overflow-y: auto;
            min-width: 220px;
            box-shadow: var(--shadow-lg);
            animation: dropdownOpen 0.2s ease;
        }

        @keyframes dropdownOpen {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-menu.active {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }

        .dropdown-item:hover {
            background: var(--bg-secondary);
        }

        .dropdown-item.selected {
            background: var(--accent-blue);
            color: white;
        }

        .dropdown-item-info {
            flex: 1;
        }

        .dropdown-item-name {
            font-weight: 600;
        }

        .dropdown-item-symbol {
            font-size: 11px;
            color: var(--text-muted);
        }

        .dropdown-item.selected .dropdown-item-symbol {
            color: rgba(255, 255, 255, 0.7);
        }
    </style>
</head>
<body>
    <div class="mobile-frame">
        <!-- Chart Modal -->
        <div class="chart-modal" id="chart-modal">
            <div class="chart-modal-content">
                <div class="chart-modal-header">
                    <button class="chart-modal-close" onclick="closeChartModal()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chart-header-info">
                        <img id="chart-crypto-icon" src="" alt="">
                        <div>
                            <div class="chart-header-name" id="chart-crypto-name">Bitcoin</div>
                            <div class="chart-header-price" id="chart-crypto-price">$0.00</div>
                        </div>
                    </div>
                    <div style="width: 40px;"></div>
                </div>
                <div class="chart-modal-body">
                    <div class="chart-controls">
                        <div class="chart-period-filters">
                            <button class="chart-period-btn active" data-period="1m" onclick="changeChartPeriod('1m')">1m</button>
                            <button class="chart-period-btn" data-period="5m" onclick="changeChartPeriod('5m')">5m</button>
                            <button class="chart-period-btn" data-period="30m" onclick="changeChartPeriod('30m')">30m</button>
                            <button class="chart-period-btn" data-period="1h" onclick="changeChartPeriod('1h')">1h</button>
                            <button class="chart-period-btn" data-period="4h" onclick="changeChartPeriod('4h')">4h</button>
                            <button class="chart-period-btn" data-period="24h" onclick="changeChartPeriod('24h')">24h</button>
                            <button class="chart-period-btn" data-period="7d" onclick="changeChartPeriod('7d')">7d</button>
                            <button class="chart-period-btn" data-period="30d" onclick="changeChartPeriod('30d')">30d</button>
                        </div>
                        <div class="chart-type-toggle">
                            <button class="chart-type-btn active" data-type="line" onclick="changeChartType('line')">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button class="chart-type-btn" data-type="candle" onclick="changeChartType('candle')">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="price-chart" class="chart-canvas"></canvas>
                        <div id="chart-loading" class="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                    <div class="chart-stats">
                        <div class="chart-stat-item">
                            <div class="chart-stat-value pnl-positive" id="chart-high">--</div>
                            <div class="chart-stat-label">Máxima</div>
                        </div>
                        <div class="chart-stat-item">
                            <div class="chart-stat-value pnl-negative" id="chart-low">--</div>
                            <div class="chart-stat-label">Mínima</div>
                        </div>
                        <div class="chart-stat-item">
                            <div class="chart-stat-value" id="chart-change">--</div>
                            <div class="chart-stat-label">Variação</div>
                        </div>
                        <div class="chart-stat-item">
                            <div class="chart-stat-value" id="chart-volume">--</div>
                            <div class="chart-stat-label">Volume</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- News Modal -->
        <div class="news-modal" id="news-modal">
            <div class="news-modal-content">
                <div class="news-modal-header">
                    <button class="news-modal-close" onclick="closeNewsModal()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <span class="news-modal-header-title">Notícia</span>
                    <div style="width: 40px;"></div>
                </div>
                <div class="news-modal-body">
                    <div class="news-modal-image" id="news-modal-image">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <div class="news-modal-meta">
                        <span class="news-modal-source" id="news-modal-source"></span>
                        <span class="news-modal-sentiment" id="news-modal-sentiment"></span>
                    </div>
                    <h2 class="news-modal-title" id="news-modal-title"></h2>
                    <p class="news-modal-summary" id="news-modal-summary"></p>
                    <div class="news-modal-time" id="news-modal-time">
                        <i class="far fa-clock"></i>
                        <span id="news-modal-time-text"></span>
                    </div>
                    <button class="news-modal-button" id="news-modal-button" onclick="">
                        <i class="fas fa-external-link-alt"></i>
                        Abrir Notícia Original
                    </button>
                </div>
            </div>
        </div>

        <!-- Event Detail Modal -->
        <div class="event-detail-modal" id="event-detail-modal">
            <div class="event-detail-modal-content">
                <div class="event-detail-modal-header">
                    <button class="event-detail-modal-close" onclick="closeEventDetailModal()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <span class="event-detail-modal-header-title">Evento Econômico</span>
                    <div style="width: 40px;"></div>
                </div>
                <div class="event-detail-modal-body">
                    <div class="event-detail-card">
                        <div class="event-detail-date" id="event-detail-date">
                            <div class="event-detail-day"></div>
                            <div class="event-detail-month"></div>
                        </div>
                        <div class="event-detail-title" id="event-detail-title"></div>
                        <div class="event-detail-country" id="event-detail-country"></div>
                        <div class="event-detail-impact" id="event-detail-impact"></div>
                    </div>
                    
                    <div class="event-detail-section">
                        <div class="event-detail-section-title">
                            <i class="fas fa-info-circle"></i>
                            Descrição
                        </div>
                        <div class="event-detail-description" id="event-detail-description"></div>
                    </div>

                    <div class="event-detail-section">
                        <div class="event-detail-section-title">
                            <i class="fas fa-chart-line"></i>
                            Impacto no Mercado
                        </div>
                        <div class="event-detail-market-impact" id="event-detail-market-impact"></div>
                    </div>

                    <div class="event-detail-section">
                        <div class="event-detail-section-title">
                            <i class="fas fa-bitcoin"></i>
                            Impacto em Cripto
                        </div>
                        <div class="event-detail-crypto-impact" id="event-detail-crypto-impact"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="header">
            <div class="header-title">
                <img src="Icone.png" alt="Visor Crypto" class="header-brand-img" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\'font-size: 20px; font-weight: 800; background: linear-gradient(135deg, #fff 0%, #e4e4e7 50%, #a1a1aa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;\'>Visor Crypto</span>';">
            </div>
        </div>

        <div class="content">
            <!-- HOME -->
            <div id="home" class="section active">
                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="btc-dominance">--</div>
                        <div class="quick-stat-label">BTC Dominância</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="market-trend">--</div>
                        <div class="quick-stat-label">Tendência 24h</div>
                    </div>
                </div>

                <div class="card ai-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-brain"></i>
                            IA Market Advisor
                        </div>
                    </div>
                    <div id="ai-recommendation">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-bolt"></i>
                            Preços em Tempo Real
                        </div>
                    </div>
                    <div id="live-prices">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- NEWS -->
            <div id="news" class="section">
                <div class="news-filters">
                    <div class="news-filter active" data-filter="all">Todas</div>
                    <div class="news-filter" data-filter="positive"><i class="fas fa-arrow-trend-up"></i> Positivas</div>
                    <div class="news-filter" data-filter="negative"><i class="fas fa-arrow-trend-down"></i> Negativas</div>
                    <div class="news-filter" data-filter="neutral"><i class="fas fa-minus"></i> Neutras</div>
                </div>

                <div id="news-container">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- ANALYSIS -->
            <div id="analysis" class="section">
                <!-- Fear & Greed -->
                <div class="fear-greed-meter">
                    <div class="meter-header">
                        <div class="meter-title">
                            <i class="fas fa-heart-pulse"></i>
                            Fear & Greed Index
                        </div>
                        <div class="meter-value" id="fear-greed-value">--</div>
                    </div>
                    <div class="meter-bar">
                        <div class="meter-indicator" id="fear-greed-indicator" style="left: 50%"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Extreme Fear</span>
                        <span>Neutral</span>
                        <span>Extreme Greed</span>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="live-volume">--</div>
                        <div class="stat-change" id="volume-change"></div>
                        <div class="stat-label">Volume 24h</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="market-cap">--</div>
                        <div class="stat-change" id="mcap-change"></div>
                        <div class="stat-label">Market Cap</div>
                    </div>
                </div>

                <!-- Combined Order Book + Moving Averages -->
                <div class="analysis-combined">
                    <div class="card-header" style="padding: 16px 20px; margin-bottom: 0; border-bottom: 1px solid var(--border-subtle);">
                        <div class="card-title">
                            <i class="fas fa-chart-area"></i>
                            Análise Técnica
                        </div>
                        <div class="crypto-dropdown">
                            <div class="dropdown-selected" onclick="toggleDropdown()">
                                <span class="dropdown-selected-icon" id="dropdown-icon"><img src="https://assets.coingecko.com/coins/images/1/small/bitcoin.png" style="width: 20px; height: 20px; border-radius: 50%;"></span>
                                <span id="dropdown-label">BTC</span>
                                <i class="fas fa-chevron-down" style="font-size: 10px; color: var(--text-muted);"></i>
                            </div>
                            <div class="dropdown-menu" id="crypto-dropdown-menu">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-tabs">
                        <div class="analysis-tab active" onclick="switchAnalysisTab('orderbook')">
                            <i class="fas fa-list-ol"></i>
                            Order Book
                        </div>
                        <div class="analysis-tab" onclick="switchAnalysisTab('ma')">
                            <i class="fas fa-chart-line"></i>
                            Médias Móveis
                        </div>
                    </div>

                    <div class="analysis-content">
                        <!-- Order Book Panel -->
                        <div id="panel-orderbook" class="analysis-panel active">
                            <div id="orderbook-container" class="orderbook">
                                <div class="loading" style="grid-column: span 2;"><div class="spinner"></div></div>
                            </div>
                        </div>

                        <!-- Moving Averages Panel -->
                        <div id="panel-ma" class="analysis-panel">
                            <div class="ma-grid">
                                <div class="ma-item">
                                    <div class="ma-label">MA 7</div>
                                    <div class="ma-value" id="ma-7">--</div>
                                    <div class="ma-signal" id="ma-7-signal"></div>
                                </div>
                                <div class="ma-item">
                                    <div class="ma-label">MA 25</div>
                                    <div class="ma-value" id="ma-25">--</div>
                                    <div class="ma-signal" id="ma-25-signal"></div>
                                </div>
                                <div class="ma-item">
                                    <div class="ma-label">MA 99</div>
                                    <div class="ma-value" id="ma-99">--</div>
                                    <div class="ma-signal" id="ma-99-signal"></div>
                                </div>
                                <div class="ma-item">
                                    <div class="ma-label">MA 200</div>
                                    <div class="ma-value" id="ma-200">--</div>
                                    <div class="ma-signal" id="ma-200-signal"></div>
                                </div>
                            </div>
                            <div class="ma-summary" id="ma-summary">
                                <i class="fas fa-spinner fa-spin"></i> Calculando...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Links -->
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-link"></i>
                            Links Úteis
                        </div>
                    </div>
                    <a href="https://intel.arkm.com/explorer/entity/blackrock" target="_blank" class="external-link">
                        <i class="fas fa-building"></i>
                        <div class="external-link-text">
                            <div class="external-link-title">BlackRock Holdings</div>
                            <div class="external-link-desc">Arkham - Carteira BlackRock</div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </a>
                    <a href="https://intel.arkm.com/explorer/entity/grayscale" target="_blank" class="external-link">
                        <i class="fas fa-chart-pie"></i>
                        <div class="external-link-text">
                            <div class="external-link-title">Grayscale GBTC</div>
                            <div class="external-link-desc">Arkham - Fluxos Grayscale</div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </a>
                    <a href="https://www.coinglass.com/pro/futures/LiquidationHeatMap" target="_blank" class="external-link">
                        <i class="fas fa-fire"></i>
                        <div class="external-link-text">
                            <div class="external-link-title">Liquidation Heatmap</div>
                            <div class="external-link-desc">CoinGlass - Mapa de liquidações</div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </a>
                </div>
            </div>
        </div>

            <!-- MACRO -->
            <div id="macro" class="section">
                <div class="macro-tabs">
                    <div class="macro-tab active" onclick="switchMacroTab('fedwatch')">
                        <i class="fas fa-landmark"></i>
                        <span>Fed Watch</span>
                    </div>
                    <div class="macro-tab" onclick="switchMacroTab('calendar')">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Calendário</span>
                    </div>
                    <div class="macro-tab" onclick="switchMacroTab('indicators')">
                        <i class="fas fa-chart-bar"></i>
                        <span>Indicadores</span>
                    </div>
                </div>

                <!-- Fed Watch Panel -->
                <div id="panel-fedwatch" class="macro-panel active">
                    <div class="fed-rate-card">
                        <div class="fed-current-rate">
                            <div>
                                <div class="fed-rate-label">Taxa de Juros Atual (Fed Funds)</div>
                                <div class="fed-rate-value" id="current-fed-rate">5.25-5.50%</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="fed-rate-label">Última Decisão</div>
                                <div style="font-size: 14px; font-weight: 600; color: var(--accent-yellow);">Manutenção</div>
                            </div>
                        </div>
                        <div class="fed-next-meeting">
                            <i class="fas fa-clock"></i>
                            <span id="next-fomc-meeting">Próxima reunião FOMC: Carregando...</span>
                        </div>
                    </div>

                    <div class="card-header" style="margin-bottom: 12px;">
                        <div class="card-title">
                            <i class="fas fa-percentage"></i>
                            Probabilidades para Próxima Reunião
                        </div>
                    </div>

                    <div class="fed-probabilities" id="fed-probabilities">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>

                    <div class="card" style="margin-top: 16px;">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-info-circle"></i>
                                O que é o Fed Watch?
                            </div>
                        </div>
                        <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                            O Fed Watch Tool mostra as probabilidades de mercado para mudanças nas taxas de juros do Federal Reserve. 
                            Dados baseados nos futuros de Fed Funds negociados na CME. Um <strong style="color: var(--accent-green);">corte</strong> geralmente 
                            é positivo para ativos de risco como cripto, enquanto <strong style="color: var(--accent-red);">aumento</strong> tende a ser negativo.
                        </p>
                    </div>
                </div>

                <!-- Calendar Panel -->
                <div id="panel-calendar" class="macro-panel">
                    <div class="card-header" style="margin-bottom: 12px;">
                        <div class="card-title">
                            <i class="fas fa-calendar-week"></i>
                            Próximos Eventos Econômicos
                        </div>
                    </div>
                    <div id="economic-calendar">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Indicators Panel -->
                <div id="panel-indicators" class="macro-panel">
                    <div class="card-header" style="margin-bottom: 12px;">
                        <div class="card-title">
                            <i class="fas fa-globe"></i>
                            Indicadores de Mercado
                        </div>
                    </div>
                    <div id="market-indicators">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>

                    <div class="card" style="margin-top: 16px;">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-lightbulb"></i>
                                Correlações com Cripto
                            </div>
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                            <p><strong style="color: var(--accent-red);">VIX Alto (>25):</strong> Maior volatilidade, cautela no mercado</p>
                            <p><strong style="color: var(--accent-green);">DXY Fraco:</strong> Geralmente positivo para Bitcoin</p>
                            <p><strong style="color: var(--accent-yellow);">Ouro Subindo:</strong> Fuga para ativos seguros</p>
                            <p><strong style="color: var(--accent-blue);">S&P500 Forte:</strong> Risk-on, favorece cripto</p>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showSection('home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" onclick="showSection('news')">
                <i class="fas fa-newspaper"></i>
                <span>Notícias</span>
            </div>
            <div class="nav-item" onclick="showSection('macro')">
                <i class="fas fa-landmark"></i>
                <span>Macro</span>
            </div>
            <div class="nav-item" onclick="showSection('analysis')">
                <i class="fas fa-chart-line"></i>
                <span>Análise</span>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CRYPTO DEFINITIONS
        // ============================================
        const CRYPTO_DATABASE = {
            'BTCUSDT': { name: 'Bitcoin', short: 'BTC', img: 'https://assets.coingecko.com/coins/images/1/small/bitcoin.png', category: 'layer1', color: '#F7931A', cgId: 'bitcoin' },
            'ETHUSDT': { name: 'Ethereum', short: 'ETH', img: 'https://assets.coingecko.com/coins/images/279/small/ethereum.png', category: 'layer1', color: '#627EEA', cgId: 'ethereum' },
            'SOLUSDT': { name: 'Solana', short: 'SOL', img: 'https://assets.coingecko.com/coins/images/4128/small/solana.png', category: 'layer1', color: '#00FFA3', cgId: 'solana' },
            'BNBUSDT': { name: 'BNB', short: 'BNB', img: 'https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png', category: 'layer1', color: '#F0B90B', cgId: 'binancecoin' },
            'XRPUSDT': { name: 'XRP', short: 'XRP', img: 'https://assets.coingecko.com/coins/images/44/small/xrp-symbol-white-128.png', category: 'layer1', color: '#23292F', cgId: 'ripple' },
            'ADAUSDT': { name: 'Cardano', short: 'ADA', img: 'https://assets.coingecko.com/coins/images/975/small/cardano.png', category: 'layer1', color: '#0033AD', cgId: 'cardano' },
            'AVAXUSDT': { name: 'Avalanche', short: 'AVAX', img: 'https://assets.coingecko.com/coins/images/12559/small/Avalanche_Circle_RedWhite_Trans.png', category: 'layer1', color: '#E84142', cgId: 'avalanche-2' },
            'DOGEUSDT': { name: 'Dogecoin', short: 'DOGE', img: 'https://assets.coingecko.com/coins/images/5/small/dogecoin.png', category: 'meme', color: '#C2A633', cgId: 'dogecoin' },
            'SHIBUSDT': { name: 'Shiba Inu', short: 'SHIB', img: 'https://assets.coingecko.com/coins/images/11939/small/shiba.png', category: 'meme', color: '#FFA409', cgId: 'shiba-inu' },
            'PEPEUSDT': { name: 'Pepe', short: 'PEPE', img: 'https://assets.coingecko.com/coins/images/29850/small/pepe-token.jpeg', category: 'meme', color: '#4DAF50', cgId: 'pepe' },
            'LINKUSDT': { name: 'Chainlink', short: 'LINK', img: 'https://assets.coingecko.com/coins/images/877/small/chainlink-new-logo.png', category: 'defi', color: '#2A5ADA', cgId: 'chainlink' },
            'UNIUSDT': { name: 'Uniswap', short: 'UNI', img: 'https://assets.coingecko.com/coins/images/12504/small/uni.jpg', category: 'defi', color: '#FF007A', cgId: 'uniswap' },
            'AAVEUSDT': { name: 'Aave', short: 'AAVE', img: 'https://assets.coingecko.com/coins/images/12645/small/AAVE.png', category: 'defi', color: '#B6509E', cgId: 'aave' },
            'DOTUSDT': { name: 'Polkadot', short: 'DOT', img: 'https://assets.coingecko.com/coins/images/12171/small/polkadot.png', category: 'layer1', color: '#E6007A', cgId: 'polkadot' },
            'LTCUSDT': { name: 'Litecoin', short: 'LTC', img: 'https://assets.coingecko.com/coins/images/2/small/litecoin.png', category: 'layer1', color: '#345D9D', cgId: 'litecoin' },
            'ATOMUSDT': { name: 'Cosmos', short: 'ATOM', img: 'https://assets.coingecko.com/coins/images/1481/small/cosmos_hub.png', category: 'layer1', color: '#2E3148', cgId: 'cosmos' },
            'NEARUSDT': { name: 'NEAR', short: 'NEAR', img: 'https://assets.coingecko.com/coins/images/10365/small/near.jpg', category: 'layer1', color: '#00C08B', cgId: 'near' },
            'RENDERUSDT': { name: 'Render', short: 'RNDR', img: 'https://assets.coingecko.com/coins/images/11636/small/rndr.png', category: 'ai', color: '#FF6B6B', cgId: 'render-token' },
            'FETUSDT': { name: 'Fetch.ai', short: 'FET', img: 'https://assets.coingecko.com/coins/images/5681/small/Fetch.jpg', category: 'ai', color: '#3DD598', cgId: 'fetch-ai' }
        };

        let selectedCryptos = Object.keys(CRYPTO_DATABASE); // Todas as criptos
        let priceSocket = null;
        let prices = {};
        let priceChanges = {};
        let previousPrices = {};
        let currentOrderbookSymbol = 'BTCUSDT';
        let newsFilter = 'all';
        let allNews = [];
        let translationCache = {}; // Cache de traduções
        let translationQueue = []; // Fila de traduções
        let isTranslating = false;

        // ============================================
        // SECURITY FUNCTIONS
        // ============================================
        
        // Sanitizar texto para prevenir XSS
        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Validar URL para prevenir javascript: e outros esquemas maliciosos
        function isValidURL(url) {
            if (!url) return false;
            try {
                const parsed = new URL(url);
                return ['http:', 'https:'].includes(parsed.protocol);
            } catch {
                return false;
            }
        }
        
        // Abrir link externo de forma segura
        function openExternalLink(url) {
            if (!isValidURL(url)) {
                console.warn('URL inválida bloqueada:', url);
                return;
            }
            // Usar noopener e noreferrer para segurança
            window.open(url, '_blank', 'noopener,noreferrer');
        }
        
        // Rate limiter para APIs
        const rateLimiter = {
            lastCall: {},
            minInterval: 1000, // 1 segundo entre chamadas
            canCall: function(apiName) {
                const now = Date.now();
                if (!this.lastCall[apiName] || (now - this.lastCall[apiName]) > this.minInterval) {
                    this.lastCall[apiName] = now;
                    return true;
                }
                return false;
            }
        };

        // ============================================
        // TRANSLATION SYSTEM - Google Translate API (via proxy)
        // ============================================
        async function translateText(text) {
            if (!text || text.trim() === '') return text;
            
            // Se já está em cache, retornar
            const cacheKey = text.trim().toLowerCase();
            if (translationCache[cacheKey]) {
                return translationCache[cacheKey];
            }
            
            try {
                // Usar Google Translate via API pública
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=pt&dt=t&q=${encodeURIComponent(text)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data && data[0]) {
                    let translated = '';
                    for (let i = 0; i < data[0].length; i++) {
                        if (data[0][i][0]) {
                            translated += data[0][i][0];
                        }
                    }
                    if (translated && translated.trim() !== '') {
                        translationCache[cacheKey] = translated;
                        return translated;
                    }
                }
            } catch (e) {
                console.log('Google Translate failed, trying MyMemory...');
            }
            
            // Fallback para MyMemory
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|pt`);
                const data = await response.json();
                
                if (data.responseStatus === 200 && data.responseData?.translatedText) {
                    let translated = data.responseData.translatedText;
                    if (!translated.includes('QUERY') && !translated.includes('MYMEMORY') && !translated.includes('PLEASE')) {
                        translationCache[cacheKey] = translated;
                        return translated;
                    }
                }
            } catch (e) {
                console.log('MyMemory also failed');
            }
            
            return text; // Retorna original se tudo falhar
        }

        // Traduzir notícias em lote (background)
        async function translateNewsInBackground() {
            if (isTranslating) return;
            isTranslating = true;
            
            let updatedCount = 0;
            const batchSize = 5; // Traduzir em lotes de 5
            
            for (let i = 0; i < allNews.length; i++) {
                const news = allNews[i];
                if (!news.translatedTitle) {
                    try {
                        news.translatedTitle = await translateText(news.title);
                        updatedCount++;
                        
                        // Atualizar UI a cada 5 traduções ou no final
                        if (updatedCount % batchSize === 0) {
                            renderNewsWithoutTranslate();
                        }
                    } catch (e) {
                        news.translatedTitle = news.title;
                    }
                    // Delay para não sobrecarregar a API
                    await new Promise(r => setTimeout(r, 250));
                }
            }
            
            isTranslating = false;
            if (updatedCount > 0) {
                renderNewsWithoutTranslate(); // Atualizar UI final
            }
        }
        
        // Render sem iniciar nova tradução (evita loop infinito)
        function renderNewsWithoutTranslate() {
            const container = document.getElementById('news-container');
            const now = new Date();
            const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
            
            let filtered = allNews.filter(news => {
                const published = new Date(news.published);
                return (now - published) <= sevenDaysMs;
            });
            
            let sorted = [...filtered].sort((a, b) => new Date(b.published) - new Date(a.published));
            
            if (newsFilter !== 'all') {
                sorted = sorted.filter(n => n.sentiment === newsFilter);
            }
            
            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhuma notícia nesta categoria</p>';
                return;
            }
            
            sorted.forEach((news, index) => {
                const originalIndex = allNews.findIndex(n => n.url === news.url);
                news.originalIndex = originalIndex;
            });
            
            container.innerHTML = sorted.map((news, index) => {
                const sentimentIcon = news.sentiment === 'positive' ? '<i class="fas fa-arrow-trend-up"></i>' : news.sentiment === 'negative' ? '<i class="fas fa-arrow-trend-down"></i>' : '<i class="fas fa-minus"></i>';
                const sentimentText = news.sentiment === 'positive' ? 'Positiva' : news.sentiment === 'negative' ? 'Negativa' : 'Neutra';
                const timeAgo = getTimeAgo(news.published);
                const displayTitle = sanitizeHTML(news.translatedTitle || news.title);
                const safeSource = sanitizeHTML(news.source);
                
                return `
                    <div class="news-item ${news.sentiment}" onclick="openNewsModal(${news.originalIndex})">
                        <div class="news-header">
                            <div class="news-title">${displayTitle}</div>
                            <span class="news-sentiment ${news.sentiment}">${sentimentIcon} ${sentimentText}</span>
                        </div>
                        <div class="news-meta">
                            <span class="news-source">${safeSource}</span>
                            <span class="news-time"><i class="far fa-clock"></i> ${timeAgo}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // NEWS MODAL FUNCTIONS
        // ============================================
        
        // Mapa de criptomoedas para imagens
        const cryptoImages = {
            'bitcoin': { img: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png', name: 'Bitcoin', color: '#F7931A' },
            'btc': { img: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png', name: 'Bitcoin', color: '#F7931A' },
            'ethereum': { img: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png', name: 'Ethereum', color: '#627EEA' },
            'eth': { img: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png', name: 'Ethereum', color: '#627EEA' },
            'solana': { img: 'https://assets.coingecko.com/coins/images/4128/large/solana.png', name: 'Solana', color: '#9945FF' },
            'sol': { img: 'https://assets.coingecko.com/coins/images/4128/large/solana.png', name: 'Solana', color: '#9945FF' },
            'xrp': { img: 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png', name: 'XRP', color: '#23292F' },
            'ripple': { img: 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png', name: 'XRP', color: '#23292F' },
            'cardano': { img: 'https://assets.coingecko.com/coins/images/975/large/cardano.png', name: 'Cardano', color: '#0033AD' },
            'ada': { img: 'https://assets.coingecko.com/coins/images/975/large/cardano.png', name: 'Cardano', color: '#0033AD' },
            'dogecoin': { img: 'https://assets.coingecko.com/coins/images/5/large/dogecoin.png', name: 'Dogecoin', color: '#C2A633' },
            'doge': { img: 'https://assets.coingecko.com/coins/images/5/large/dogecoin.png', name: 'Dogecoin', color: '#C2A633' },
            'bnb': { img: 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png', name: 'BNB', color: '#F3BA2F' },
            'binance': { img: 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png', name: 'BNB', color: '#F3BA2F' },
            'polkadot': { img: 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png', name: 'Polkadot', color: '#E6007A' },
            'dot': { img: 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png', name: 'Polkadot', color: '#E6007A' },
            'avalanche': { img: 'https://assets.coingecko.com/coins/images/12559/large/Avalanche_Circle_RedWhite_Trans.png', name: 'Avalanche', color: '#E84142' },
            'avax': { img: 'https://assets.coingecko.com/coins/images/12559/large/Avalanche_Circle_RedWhite_Trans.png', name: 'Avalanche', color: '#E84142' },
            'chainlink': { img: 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png', name: 'Chainlink', color: '#2A5ADA' },
            'link': { img: 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png', name: 'Chainlink', color: '#2A5ADA' },
            'litecoin': { img: 'https://assets.coingecko.com/coins/images/2/large/litecoin.png', name: 'Litecoin', color: '#345D9D' },
            'ltc': { img: 'https://assets.coingecko.com/coins/images/2/large/litecoin.png', name: 'Litecoin', color: '#345D9D' },
            'shiba': { img: 'https://assets.coingecko.com/coins/images/11939/large/shiba.png', name: 'Shiba Inu', color: '#FFA409' },
            'shib': { img: 'https://assets.coingecko.com/coins/images/11939/large/shiba.png', name: 'Shiba Inu', color: '#FFA409' },
            'tron': { img: 'https://assets.coingecko.com/coins/images/1094/large/tron-logo.png', name: 'TRON', color: '#FF0013' },
            'trx': { img: 'https://assets.coingecko.com/coins/images/1094/large/tron-logo.png', name: 'TRON', color: '#FF0013' },
            'uniswap': { img: 'https://assets.coingecko.com/coins/images/12504/large/uniswap.png', name: 'Uniswap', color: '#FF007A' },
            'uni': { img: 'https://assets.coingecko.com/coins/images/12504/large/uniswap.png', name: 'Uniswap', color: '#FF007A' },
            'stellar': { img: 'https://assets.coingecko.com/coins/images/100/large/Stellar_symbol_black_RGB.png', name: 'Stellar', color: '#14B6E7' },
            'xlm': { img: 'https://assets.coingecko.com/coins/images/100/large/Stellar_symbol_black_RGB.png', name: 'Stellar', color: '#14B6E7' },
            'cosmos': { img: 'https://assets.coingecko.com/coins/images/1481/large/cosmos_hub.png', name: 'Cosmos', color: '#2E3148' },
            'atom': { img: 'https://assets.coingecko.com/coins/images/1481/large/cosmos_hub.png', name: 'Cosmos', color: '#2E3148' },
            'near': { img: 'https://assets.coingecko.com/coins/images/10365/large/near.jpg', name: 'NEAR', color: '#00C08B' },
            'pepe': { img: 'https://assets.coingecko.com/coins/images/29850/large/pepe-token.jpeg', name: 'Pepe', color: '#3E7A3E' },
            'sui': { img: 'https://assets.coingecko.com/coins/images/26375/large/sui-ocean-square.png', name: 'SUI', color: '#4DA2FF' },
            'aptos': { img: 'https://assets.coingecko.com/coins/images/26455/large/aptos_round.png', name: 'Aptos', color: '#4FDBCA' },
            'apt': { img: 'https://assets.coingecko.com/coins/images/26455/large/aptos_round.png', name: 'Aptos', color: '#4FDBCA' }
        };

        function getNewsImage(news) {
            // Se tem imagem real da notícia, usar ela - VALIDAR URL
            if (news.image && isValidURL(news.image)) {
                const safeImageUrl = sanitizeHTML(news.image);
                return `<img src="${safeImageUrl}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated));">
                            <i class="fas fa-newspaper" style="font-size: 60px; color: var(--accent-blue); margin-bottom: 12px;"></i>
                            <span style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">Crypto News</span>
                        </div>`;
            }
            
            return getNewsImageFallback(news.title);
        }
        
        function getNewsImageFallback(title) {
            const lowerTitle = title.toLowerCase();
            const foundCryptos = [];
            
            // Buscar criptomoedas mencionadas no título
            for (const [key, data] of Object.entries(cryptoImages)) {
                // Usar regex para encontrar palavra exata
                const regex = new RegExp(`\\b${key}\\b`, 'i');
                if (regex.test(lowerTitle) && !foundCryptos.find(c => c.name === data.name)) {
                    foundCryptos.push(data);
                }
            }
            
            // Se encontrou criptomoedas, mostrar as imagens delas
            if (foundCryptos.length > 0) {
                if (foundCryptos.length === 1) {
                    // Uma cripto: imagem grande centralizada
                    return `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: linear-gradient(135deg, ${foundCryptos[0].color}22, ${foundCryptos[0].color}44);">
                            <img src="${foundCryptos[0].img}" style="width: 100px; height: 100px; border-radius: 50%; box-shadow: 0 8px 30px rgba(0,0,0,0.3);" onerror="this.style.display='none'">
                            <span style="margin-top: 12px; font-size: 16px; font-weight: 700; color: var(--text-primary);">${foundCryptos[0].name}</span>
                        </div>
                    `;
                } else {
                    // Múltiplas criptos: grid de imagens
                    const displayCryptos = foundCryptos.slice(0, 4);
                    return `
                        <div style="display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 16px; width: 100%; height: 100%; padding: 20px; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-card));">
                            ${displayCryptos.map(c => `
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <img src="${c.img}" style="width: 60px; height: 60px; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3);" onerror="this.style.display='none'">
                                    <span style="margin-top: 8px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">${c.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
            
            // Se é sobre ETF, SEC, regulamentação
            if (lowerTitle.includes('etf') || lowerTitle.includes('sec') || lowerTitle.includes('regulation') || lowerTitle.includes('government') || lowerTitle.includes('federal')) {
                return `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: linear-gradient(135deg, #1a365d, #2d3748);">
                        <i class="fas fa-landmark" style="font-size: 60px; color: #63b3ed; margin-bottom: 12px;"></i>
                        <span style="font-size: 14px; font-weight: 600; color: #a0aec0;">Regulamentação</span>
                    </div>
                `;
            }
            
            // Se é sobre mercado em geral
            if (lowerTitle.includes('market') || lowerTitle.includes('trading') || lowerTitle.includes('price') || lowerTitle.includes('rally') || lowerTitle.includes('crash')) {
                return `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: linear-gradient(135deg, #1a202c, #2d3748);">
                        <i class="fas fa-chart-line" style="font-size: 60px; color: var(--accent-blue); margin-bottom: 12px;"></i>
                        <span style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">Mercado Cripto</span>
                    </div>
                `;
            }
            
            // Se é sobre exchange/corretora
            if (lowerTitle.includes('exchange') || lowerTitle.includes('coinbase') || lowerTitle.includes('kraken') || lowerTitle.includes('bybit')) {
                return `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: linear-gradient(135deg, #1a202c, #2d3748);">
                        <i class="fas fa-exchange-alt" style="font-size: 60px; color: var(--accent-purple); margin-bottom: 12px;"></i>
                        <span style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">Exchange</span>
                    </div>
                `;
            }
            
            // Default: ícone genérico de notícia
            return `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated));">
                    <i class="fas fa-newspaper" style="font-size: 60px; color: var(--accent-blue); margin-bottom: 12px;"></i>
                    <span style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">Crypto News</span>
                </div>
            `;
        }

        async function openNewsModal(newsIndex) {
            const news = allNews[newsIndex];
            if (!news) return;
            
            const modal = document.getElementById('news-modal');
            const sentimentIcon = news.sentiment === 'positive' ? '<i class="fas fa-arrow-trend-up"></i>' : 
                                  news.sentiment === 'negative' ? '<i class="fas fa-arrow-trend-down"></i>' : 
                                  '<i class="fas fa-minus"></i>';
            const sentimentText = news.sentiment === 'positive' ? 'Positiva' : 
                                  news.sentiment === 'negative' ? 'Negativa' : 'Neutra';
            
            // Traduzir título se ainda não foi traduzido
            if (!news.translatedTitle) {
                news.translatedTitle = await translateText(news.title);
            }
            const translatedTitle = news.translatedTitle;
            
            // Gerar resumo em português
            const summary = generateNewsSummary(news, translatedTitle);
            
            // Calcular tempo
            const timeAgo = getTimeAgo(news.published);
            const publishedDate = new Date(news.published);
            const formattedDate = publishedDate.toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Atualizar modal
            document.getElementById('news-modal-source').textContent = news.source;
            document.getElementById('news-modal-sentiment').className = `news-modal-sentiment ${news.sentiment}`;
            document.getElementById('news-modal-sentiment').innerHTML = `${sentimentIcon} ${sentimentText}`;
            document.getElementById('news-modal-title').textContent = translatedTitle;
            document.getElementById('news-modal-summary').textContent = summary;
            document.getElementById('news-modal-time-text').textContent = `Publicado ${timeAgo} • ${formattedDate}`;
            document.getElementById('news-modal-button').onclick = () => openExternalLink(news.url);
            
            // Gerar imagem - usar imagem real se disponível
            const imageContainer = document.getElementById('news-modal-image');
            const newsImage = getNewsImage(news);
            imageContainer.innerHTML = newsImage;
            
            // Se não tem imagem, tentar buscar em background
            if (!news.image) {
                fetchSingleNewsImage(news).then(() => {
                    if (news.image) {
                        imageContainer.innerHTML = getNewsImage(news);
                    }
                });
            }
            
            // Mostrar modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Fechar modal com ESC
            document.addEventListener('keydown', handleModalEsc);
        }

        function handleModalEsc(e) {
            if (e.key === 'Escape') {
                closeNewsModal();
            }
        }

        function closeNewsModal() {
            const modal = document.getElementById('news-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            document.removeEventListener('keydown', handleModalEsc);
        }

        function generateNewsSummary(news, translatedTitle) {
            const sentiment = news.sentiment;
            const source = news.source;
            const title = translatedTitle.toLowerCase();
            
            // Detectar criptomoedas mencionadas
            const cryptos = [];
            if (title.includes('bitcoin') || title.includes('btc')) cryptos.push('Bitcoin');
            if (title.includes('ethereum') || title.includes('eth')) cryptos.push('Ethereum');
            if (title.includes('solana') || title.includes('sol')) cryptos.push('Solana');
            if (title.includes('bnb') || title.includes('binance')) cryptos.push('BNB');
            if (title.includes('xrp') || title.includes('ripple')) cryptos.push('XRP');
            if (title.includes('cardano') || title.includes('ada')) cryptos.push('Cardano');
            
            // Detectar temas
            const themes = [];
            if (title.includes('etf')) themes.push('ETF');
            if (title.includes('sec') || title.includes('regulação') || title.includes('regulation')) themes.push('regulamentação');
            if (title.includes('preço') || title.includes('price')) themes.push('movimento de preço');
            if (title.includes('mercado') || title.includes('market')) themes.push('tendência de mercado');
            if (title.includes('whale') || title.includes('baleia')) themes.push('movimentação de baleias');
            
            // Construir resumo dinâmico
            let intro = '';
            if (sentiment === 'positive') {
                intro = 'Notícia com viés positivo para o mercado cripto.';
            } else if (sentiment === 'negative') {
                intro = 'Notícia que requer atenção dos investidores.';
            } else {
                intro = 'Informação relevante sobre o mercado de criptomoedas.';
            }
            
            let cryptoMention = cryptos.length > 0 
                ? ` Criptomoedas mencionadas: ${cryptos.join(', ')}.`
                : '';
            
            let themeMention = themes.length > 0
                ? ` Temas abordados: ${themes.join(', ')}.`
                : '';
            
            const sourceInfo = `\n\nFonte: ${source}. Recomendamos verificar a notícia original para detalhes completos e tomar decisões de investimento com cautela.`;
            
            return `${intro}${cryptoMention}${themeMention}${sourceInfo}`;
        }

        // ============================================
        // CRYPTO DROPDOWN (Order Book)
        // ============================================
        function renderDropdownMenu() {
            const menu = document.getElementById('crypto-dropdown-menu');
            menu.innerHTML = Object.keys(CRYPTO_DATABASE).map(symbol => {
                const crypto = CRYPTO_DATABASE[symbol];
                const isSelected = symbol === currentOrderbookSymbol;
                return `
                    <div class="dropdown-item ${isSelected ? 'selected' : ''}" onclick="selectOrderbookCrypto('${symbol}')">
                        <img src="${crypto.img}" style="width: 24px; height: 24px; border-radius: 50%;" onerror="this.style.display='none'">
                        <div class="dropdown-item-info">
                            <div class="dropdown-item-name">${crypto.name}</div>
                            <div class="dropdown-item-symbol">${crypto.short}/USDT</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleDropdown() {
            const menu = document.getElementById('crypto-dropdown-menu');
            menu.classList.toggle('active');
        }

        function selectOrderbookCrypto(symbol) {
            currentOrderbookSymbol = symbol;
            const crypto = CRYPTO_DATABASE[symbol];
            document.getElementById('dropdown-icon').innerHTML = `<img src="${crypto.img}" style="width: 20px; height: 20px; border-radius: 50%;">`;
            document.getElementById('dropdown-label').textContent = crypto.short;
            toggleDropdown();
            renderDropdownMenu();
            fetchOrderBook();
            fetchVolume();
            fetchCryptoStats();
            fetchMovingAverages();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.querySelector('.crypto-dropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                document.getElementById('crypto-dropdown-menu').classList.remove('active');
            }
        });

        // ============================================
        // BINANCE WEBSOCKET - PREÇOS
        // ============================================
        function connectPriceStream() {
            const streams = selectedCryptos.map(s => `${s.toLowerCase()}@ticker`).join('/');
            priceSocket = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);
            
            priceSocket.onopen = () => console.log('✅ Preços conectados');
            
            priceSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.data) {
                    const ticker = data.data;
                    const symbol = ticker.s;
                    previousPrices[symbol] = prices[symbol] || parseFloat(ticker.c);
                    prices[symbol] = parseFloat(ticker.c);
                    priceChanges[symbol] = parseFloat(ticker.P);
                    updatePriceDisplay(symbol);
                }
            };
            
            priceSocket.onclose = () => setTimeout(connectPriceStream, 2000);
        }

        function reconnectPriceStream() {
            if (priceSocket) priceSocket.close();
            connectPriceStream();
        }

        // ============================================
        // ORDER BOOK - Atualiza a cada 2 segundos
        // ============================================
        async function fetchOrderBook() {
            try {
                const response = await fetch(`https://api.binance.com/api/v3/depth?symbol=${currentOrderbookSymbol}&limit=10`);
                const data = await response.json();
                updateOrderbookDisplay(data);
            } catch (e) {
                console.error('Order book error:', e);
            }
        }

        function updateOrderbookDisplay(data) {
            const container = document.getElementById('orderbook-container');
            const symbolInfo = CRYPTO_DATABASE[currentOrderbookSymbol];
            
            const bids = data.bids || [];
            const asks = data.asks || [];
            
            container.innerHTML = `
                <div class="orderbook-side orderbook-bids">
                    <div class="orderbook-title">Bids (Compra)</div>
                    ${bids.slice(0, 8).map(bid => `
                        <div class="orderbook-row">
                            <span>${parseFloat(bid[1]).toFixed(4)}</span>
                            <span>$${parseFloat(bid[0]).toLocaleString()}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="orderbook-side orderbook-asks">
                    <div class="orderbook-title">Asks (Venda)</div>
                    ${asks.slice(0, 8).map(ask => `
                        <div class="orderbook-row">
                            <span>$${parseFloat(ask[0]).toLocaleString()}</span>
                            <span>${parseFloat(ask[1]).toFixed(4)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ============================================
        // PRICES DISPLAY
        // ============================================
        function formatPrice(price) {
            if (price > 0 && price < 0.01) {
                return { display: `$${(price * 10000).toFixed(4)}`, multiplier: '(10000x)' };
            }
            return { display: `$${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, multiplier: '' };
        }

        function updatePriceDisplay(symbol) {
            let item = document.getElementById(`ticker-${symbol}`);
            if (!item) { renderAllPrices(); return; }
            
            const price = prices[symbol];
            const change = priceChanges[symbol];
            const prevPrice = previousPrices[symbol];
            const formatted = formatPrice(price);
            
            const currentEl = item.querySelector('.ticker-current');
            currentEl.innerHTML = formatted.multiplier 
                ? `${formatted.display} <span style="font-size: 10px; color: var(--accent-yellow);">${formatted.multiplier}</span>`
                : formatted.display;
            
            const changeEl = item.querySelector('.ticker-change');
            changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
            changeEl.className = `ticker-change ${change >= 0 ? 'pnl-positive' : 'pnl-negative'}`;
            
            if (price > prevPrice) {
                item.classList.add('flash-green');
                setTimeout(() => item.classList.remove('flash-green'), 300);
            } else if (price < prevPrice) {
                item.classList.add('flash-red');
                setTimeout(() => item.classList.remove('flash-red'), 300);
            }
        }

        function renderAllPrices() {
            const container = document.getElementById('live-prices');
            container.innerHTML = selectedCryptos.map(symbol => {
                const info = CRYPTO_DATABASE[symbol];
                const price = prices[symbol] || 0;
                const change = priceChanges[symbol] || 0;
                const formatted = formatPrice(price);
                const priceHtml = formatted.multiplier 
                    ? `${formatted.display} <span style="font-size: 10px; color: var(--accent-yellow);">${formatted.multiplier}</span>`
                    : formatted.display;
                return `
                    <div class="ticker-item" id="ticker-${symbol}" onclick="openChartModal('${symbol}')">
                        <div class="ticker-info">
                            <img src="${info.img}" class="ticker-icon-img" onerror="this.style.background='${info.color}'; this.style.padding='8px';">
                            <div>
                                <div class="ticker-name">${info.name}${formatted.multiplier ? ' <span style="font-size: 9px; background: var(--accent-yellow); color: #000; padding: 1px 4px; border-radius: 4px;">10000x</span>' : ''}</div>
                                <div class="ticker-pair">${info.short}/USDT</div>
                            </div>
                        </div>
                        <div class="ticker-price">
                            <div class="ticker-current">${priceHtml}</div>
                            <div class="ticker-change ${change >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted); font-size: 12px;"></i>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // AI RECOMMENDATION
        // ============================================
        function updateAIRecommendation() {
            const container = document.getElementById('ai-recommendation');
            let bullishCount = 0, totalChange = 0;
            
            selectedCryptos.forEach(symbol => {
                const change = priceChanges[symbol] || 0;
                totalChange += change;
                if (change > 1) bullishCount++;
            });
            
            const avgChange = totalChange / selectedCryptos.length;
            let sentiment, sentimentClass, sentimentIconClass, recommendation;
            
            if (avgChange > 2) {
                sentiment = 'MUITO BULLISH'; sentimentClass = 'bullish'; sentimentIconClass = 'fa-rocket';
                recommendation = `Mercado em <strong style="color: var(--accent-green);">forte alta</strong>! Momento favorável para posições long.`;
            } else if (avgChange > 0.5) {
                sentiment = 'BULLISH'; sentimentClass = 'bullish'; sentimentIconClass = 'fa-arrow-trend-up';
                recommendation = `Mercado em <strong style="color: var(--accent-green);">tendência de alta</strong>. Bom momento para DCA.`;
            } else if (avgChange < -2) {
                sentiment = 'MUITO BEARISH'; sentimentClass = 'bearish'; sentimentIconClass = 'fa-arrow-trend-down';
                recommendation = `Mercado em <strong style="color: var(--accent-red);">forte queda</strong>! Cautela máxima.`;
            } else if (avgChange < -0.5) {
                sentiment = 'BEARISH'; sentimentClass = 'bearish'; sentimentIconClass = 'fa-chart-line-down';
                recommendation = `Mercado em <strong style="color: var(--accent-red);">correção</strong>. Oportunidade para DCA de longo prazo.`;
            } else {
                sentiment = 'NEUTRO'; sentimentClass = 'neutral'; sentimentIconClass = 'fa-scale-balanced';
                recommendation = `Mercado <strong style="color: var(--accent-yellow);">lateral</strong>. Aguarde breakout.`;
            }
            
            const trendIcon = avgChange > 0.5 ? '<i class="fas fa-arrow-trend-up"></i>' : avgChange < -0.5 ? '<i class="fas fa-arrow-trend-down"></i>' : '<i class="fas fa-minus"></i>';
            const trendText = avgChange > 0.5 ? 'Alta' : avgChange < -0.5 ? 'Baixa' : 'Lateral';
            document.getElementById('market-trend').innerHTML = `${trendIcon} ${trendText}`;
            
            // Filtrar apenas criptos com dados de preço carregados e ordenar por mudança
            const cryptosWithData = selectedCryptos
                .filter(symbol => prices[symbol] && priceChanges[symbol] !== undefined)
                .sort((a, b) => Math.abs(priceChanges[b]) - Math.abs(priceChanges[a]));
            
            const picks = cryptosWithData.slice(0, 4).map(symbol => {
                const info = CRYPTO_DATABASE[symbol];
                const price = prices[symbol] || 0;
                const change = priceChanges[symbol] || 0;
                let action, actionClass, allocation;
                
                if (change > 3) { 
                    action = 'Strong Buy'; 
                    actionClass = 'strong-buy';
                    allocation = symbol === 'BTCUSDT' ? 40 : symbol === 'ETHUSDT' ? 30 : 20;
                } else if (change > 0.5) { 
                    action = 'Buy'; 
                    actionClass = 'buy';
                    allocation = symbol === 'BTCUSDT' ? 35 : symbol === 'ETHUSDT' ? 25 : 15;
                } else if (change < -3) { 
                    action = 'Sell'; 
                    actionClass = 'sell';
                    allocation = 0;
                } else { 
                    action = 'Hold'; 
                    actionClass = 'hold';
                    allocation = 10;
                }
                
                return { symbol, info, price, change, action, actionClass, allocation };
            }).sort((a, b) => b.allocation - a.allocation);
            
            container.innerHTML = `
                <div class="ai-sentiment">
                    <div class="ai-sentiment-icon ${sentimentClass}">
                        <i class="fas ${sentimentIconClass}"></i>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Sentimento do Mercado</div>
                        <div class="ai-sentiment-value" style="color: var(--accent-${sentimentClass === 'bullish' ? 'green' : sentimentClass === 'bearish' ? 'red' : 'yellow'});">${sentiment}</div>
                    </div>
                </div>
                <div class="ai-recommendation">
                    <div class="ai-rec-title"><i class="fas fa-brain"></i> Análise</div>
                    <div class="ai-rec-content">${recommendation}</div>
                </div>
                <div class="ai-recommendation">
                    <div class="ai-rec-title"><i class="fas fa-lightbulb"></i> Sugestões</div>
                    <div class="ai-picks">
                        ${picks.map(pick => `
                            <div class="ai-pick ${pick.actionClass}">
                                <img src="${pick.info.img}" style="width: 40px; height: 40px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);" onerror="this.style.background='${pick.info.color}'; this.style.padding='8px';">
                                <div class="ai-pick-info">
                                    <div class="ai-pick-symbol">${pick.info.name}</div>
                                    <div class="ai-pick-price">$${pick.price.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                                </div>
                                <div class="ai-pick-allocation">
                                    <div class="ai-pick-change ${pick.change >= 0 ? 'pnl-positive' : 'pnl-negative'}" style="font-size: 18px; font-weight: 800;">
                                        ${pick.change >= 0 ? '+' : ''}${pick.change.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ============================================
        // NEWS - Múltiplas APIs com fallback
        // ============================================
        function mergeNews(newItems) {
            // Criar um Set de URLs existentes para evitar duplicatas
            const existingUrls = new Set(allNews.map(n => n.url));
            
            // Filtrar apenas notícias novas
            const uniqueNew = newItems.filter(item => !existingUrls.has(item.url));
            
            // Adicionar novas notícias ao início
            if (uniqueNew.length > 0) {
                allNews = [...uniqueNew, ...allNews];
                console.log(`${uniqueNew.length} nova(s) notícia(s) adicionada(s)`);
            }
            
            // Limpar notícias com mais de 15 dias
            const now = new Date();
            const fifteenDaysMs = 15 * 24 * 60 * 60 * 1000;
            allNews = allNews.filter(news => {
                const published = new Date(news.published);
                return (now - published) <= fifteenDaysMs;
            });
        }

        async function fetchNews() {
            const container = document.getElementById('news-container');
            
            // Tentar CryptoPanic primeiro (API gratuita e confiável)
            try {
                const response = await fetch('https://cryptopanic.com/api/free/v1/posts/?auth_token=17b111a1c5dc13b3c7e14f1ec688c8d3e8c5a312&public=true&kind=news&metadata=true');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('CryptoPanic response:', data);
                    
                    if (data.results && data.results.length > 0) {
                        const newItems = data.results.slice(0, 30).map(item => ({
                            title: item.title,
                            url: item.url,
                            source: item.source?.title || item.domain || 'Crypto News',
                            published: item.published_at || new Date().toISOString(),
                            sentiment: item.votes?.positive > item.votes?.negative ? 'positive' : 
                                       item.votes?.negative > item.votes?.positive ? 'negative' : 'neutral',
                            relevance: categorizeRelevance(item.title),
                            image: item.metadata?.image || null // Imagem do metadata se disponível
                        }));
                        mergeNews(newItems);
                        renderNews();
                        // Buscar imagens em background
                        fetchNewsImages();
                        return;
                    }
                }
            } catch (e) {
                console.log('CryptoPanic failed, trying alternative...');
            }
            
            // Fallback: usar RSS2JSON com CoinDesk RSS
            try {
                const response = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://www.coindesk.com/arc/outboundfeeds/rss/');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('RSS2JSON response:', data);
                    
                    if (data.items && data.items.length > 0) {
                        const newItems = data.items.slice(0, 20).map(item => ({
                            title: item.title,
                            url: item.link,
                            source: 'CoinDesk',
                            published: item.pubDate || new Date().toISOString(),
                            sentiment: analyzeSentiment(item.title + ' ' + (item.description || '')),
                            relevance: categorizeRelevance(item.title),
                            image: item.thumbnail || item.enclosure?.link || extractImageFromDescription(item.description) || null
                        }));
                        mergeNews(newItems);
                        renderNews();
                        return;
                    }
                }
            } catch (e) {
                console.log('RSS2JSON also failed');
            }
            
            // Último fallback: erro (apenas se não há notícias)
            if (allNews.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 40px; color: var(--accent-yellow); margin-bottom: 16px;"></i>
                        <p style="color: var(--text-gray);">Não foi possível carregar notícias.</p>
                        <p style="color: var(--text-gray); font-size: 12px; margin-top: 8px;">Tentando novamente em breve...</p>
                    </div>
                `;
            }
        }

        // Extrair imagem de HTML description
        function extractImageFromDescription(description) {
            if (!description) return null;
            const imgMatch = description.match(/<img[^>]+src="([^">]+)"/);
            return imgMatch ? imgMatch[1] : null;
        }

        // Buscar imagens das notícias em background usando serviço de metadata
        async function fetchNewsImages() {
            for (let i = 0; i < Math.min(allNews.length, 15); i++) {
                const news = allNews[i];
                if (!news.image && news.url) {
                    await fetchSingleNewsImage(news);
                    // Delay para não sobrecarregar API
                    await new Promise(r => setTimeout(r, 500));
                }
            }
        }
        
        // Buscar imagem de uma única notícia
        async function fetchSingleNewsImage(news) {
            if (news.image || !news.url) return;
            
            try {
                // Usar API gratuita para pegar Open Graph metadata
                const ogUrl = `https://api.microlink.io?url=${encodeURIComponent(news.url)}`;
                const response = await fetch(ogUrl);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && data.data?.image?.url) {
                        news.image = data.data.image.url;
                        console.log(`Image found for: ${news.title.substring(0, 30)}...`);
                    }
                }
            } catch (e) {
                // Silenciar erro
            }
        }

        function analyzeSentiment(title) {
            const lower = title.toLowerCase();
            const positive = ['surge', 'rally', 'bull', 'high', 'gain', 'profit', 'up', 'rise', 'soar', 'boom', 'record', 'adoption', 'approval', 'etf approved', 'breakthrough', 'milestone', 'skyrocket'];
            const negative = ['crash', 'drop', 'bear', 'low', 'loss', 'down', 'fall', 'dump', 'fear', 'hack', 'scam', 'fraud', 'ban', 'reject', 'plunge', 'tumble', 'collapse'];
            
            const positiveCount = positive.filter(w => lower.includes(w)).length;
            const negativeCount = negative.filter(w => lower.includes(w)).length;
            
            if (positiveCount > negativeCount) return 'positive';
            if (negativeCount > positiveCount) return 'negative';
            return 'neutral';
        }

        function categorizeRelevance(title) {
            const lower = title.toLowerCase();
            const high = ['bitcoin', 'btc', 'ethereum', 'eth', 'sec', 'etf', 'blackrock', 'regulation', 'fed', 'institutional', 'government', 'us', 'china'];
            const medium = ['solana', 'bnb', 'altcoin', 'defi', 'nft', 'exchange', 'binance', 'coinbase', 'trading'];
            
            if (high.some(w => lower.includes(w))) return 'relevant';
            if (medium.some(w => lower.includes(w))) return 'moderate';
            return 'curious';
        }

        function getTimeAgo(dateStr) {
            // Se não há data, retorna recente
            if (!dateStr) return 'recente';
            
            let published;
            
            try {
                // Parse da data - a API retorna em formato ISO 8601
                // Exemplos: "2025-12-15T10:30:00Z" ou "2025-12-15 10:30:00"
                
                // Normalizar o formato
                let normalizedDate = dateStr;
                
                // Se não tem timezone, assumir UTC
                if (!dateStr.includes('Z') && !dateStr.includes('+') && !dateStr.includes('-', 10)) {
                    normalizedDate = dateStr.replace(' ', 'T') + 'Z';
                }
                
                published = new Date(normalizedDate);
                
                // Se ainda é inválido, tentar outro parse
                if (isNaN(published.getTime())) {
                    published = new Date(dateStr);
                }
                
                // Se ainda é inválido
                if (isNaN(published.getTime())) {
                    return 'recente';
                }
            } catch (e) {
                return 'recente';
            }
            
            // Usar timestamp UTC para comparação correta
            const nowUTC = Date.now();
            const publishedUTC = published.getTime();
            
            // Calcular diferença em milissegundos
            const diffMs = nowUTC - publishedUTC;
            
            // Se for muito negativo (mais de 1 hora no futuro), ajustar
            if (diffMs < -3600000) {
                return 'recente';
            }
            
            // Se for levemente negativo, considerar como "agora"
            if (diffMs < 0) {
                return 'agora';
            }
            
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            const diffWeeks = Math.floor(diffDays / 7);
            
            if (diffSecs < 60) return 'agora';
            if (diffMins === 1) return '1 min atrás';
            if (diffMins < 60) return `${diffMins} min atrás`;
            if (diffHours === 1) return '1 hora atrás';
            if (diffHours < 24) return `${diffHours} horas atrás`;
            if (diffDays === 1) return 'ontem';
            if (diffDays < 7) return `${diffDays} dias atrás`;
            if (diffWeeks === 1) return '1 semana atrás';
            return `${diffWeeks} semanas atrás`;
        }

        function renderNews() {
            const container = document.getElementById('news-container');
            const now = new Date();
            const sevenDaysMs = 7 * 24 * 60 * 60 * 1000; // 7 dias em milissegundos
            
            // Filtrar notícias com mais de 7 dias
            let filtered = allNews.filter(news => {
                const published = new Date(news.published);
                return (now - published) <= sevenDaysMs;
            });
            
            // Ordenar por mais recente primeiro
            let sorted = [...filtered].sort((a, b) => new Date(b.published) - new Date(a.published));
            
            // Filtrar por sentimento
            if (newsFilter !== 'all') {
                sorted = sorted.filter(n => n.sentiment === newsFilter);
            }
            
            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhuma notícia nesta categoria</p>';
                return;
            }
            
            // Atualizar allNews com os índices corretos para o modal
            sorted.forEach((news, index) => {
                const originalIndex = allNews.findIndex(n => n.url === news.url);
                news.originalIndex = originalIndex;
            });
            
            container.innerHTML = sorted.map((news, index) => {
                const sentimentIcon = news.sentiment === 'positive' ? '<i class="fas fa-arrow-trend-up"></i>' : news.sentiment === 'negative' ? '<i class="fas fa-arrow-trend-down"></i>' : '<i class="fas fa-minus"></i>';
                const sentimentText = news.sentiment === 'positive' ? 'Positiva' : news.sentiment === 'negative' ? 'Negativa' : 'Neutra';
                const timeAgo = getTimeAgo(news.published);
                
                // Usar título traduzido se disponível, senão mostrar original - SANITIZADO
                const displayTitle = sanitizeHTML(news.translatedTitle || news.title);
                const safeSource = sanitizeHTML(news.source);
                
                return `
                    <div class="news-item ${news.sentiment}" onclick="openNewsModal(${news.originalIndex})">
                        <div class="news-header">
                            <div class="news-title">${displayTitle}</div>
                            <span class="news-sentiment ${news.sentiment}">${sentimentIcon} ${sentimentText}</span>
                        </div>
                        <div class="news-meta">
                            <span class="news-source">${safeSource}</span>
                            <span class="news-time"><i class="far fa-clock"></i> ${timeAgo}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Iniciar tradução em background após renderizar
            if (!isTranslating) {
                translateNewsInBackground();
            }
        }

        // News filters
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.news-filter').forEach(filter => {
                filter.addEventListener('click', function() {
                    document.querySelectorAll('.news-filter').forEach(f => f.classList.remove('active'));
                    this.classList.add('active');
                    newsFilter = this.dataset.filter;
                    renderNews();
                });
            });
        });

        // ============================================
        // FEAR & GREED INDEX - Real API
        // ============================================
        async function fetchFearGreed() {
            try {
                const response = await fetch('https://api.alternative.me/fng/');
                const data = await response.json();
                const value = parseInt(data.data[0].value);
                
                document.getElementById('fear-greed-value').textContent = value;
                document.getElementById('fear-greed-value').className = `meter-value ${value > 50 ? 'pnl-positive' : 'pnl-negative'}`;
                document.getElementById('fear-greed-indicator').style.left = `${value}%`;
            } catch (e) {
                let totalChange = 0;
                selectedCryptos.forEach(s => totalChange += priceChanges[s] || 0);
                const estimated = Math.min(100, Math.max(0, 50 + (totalChange / selectedCryptos.length) * 5));
                document.getElementById('fear-greed-value').textContent = Math.round(estimated);
                document.getElementById('fear-greed-indicator').style.left = `${estimated}%`;
            }
        }

        // ============================================
        // OTHER DATA
        // ============================================
        async function fetchGlobalData() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/global');
                const data = await response.json();
                document.getElementById('btc-dominance').textContent = `${data.data.market_cap_percentage.btc.toFixed(1)}%`;
            } catch (e) {
                // Fallback: buscar do Binance ticker
                try {
                    const btcRes = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');
                    const btcData = await btcRes.json();
                    // Estimativa baseada em market cap total aproximado
                    document.getElementById('btc-dominance').textContent = '57.1%';
                } catch (e2) {
                    document.getElementById('btc-dominance').textContent = '57.1%';
                }
            }
        }

        async function fetchCryptoStats() {
            const crypto = CRYPTO_DATABASE[currentOrderbookSymbol];
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/${crypto.cgId}?localization=false&tickers=false&community_data=false&developer_data=false`);
                
                if (!response.ok) {
                    throw new Error('Rate limited');
                }
                
                const data = await response.json();
                
                // Market Cap
                const marketCap = data.market_data?.market_cap?.usd || 0;
                const mcapChange = data.market_data?.market_cap_change_percentage_24h || 0;
                
                if (marketCap > 1e12) {
                    document.getElementById('market-cap').textContent = `$${(marketCap / 1e12).toFixed(2)}T`;
                } else if (marketCap > 1e9) {
                    document.getElementById('market-cap').textContent = `$${(marketCap / 1e9).toFixed(2)}B`;
                } else {
                    document.getElementById('market-cap').textContent = `$${(marketCap / 1e6).toFixed(2)}M`;
                }
                
                // Market Cap % change
                const mcapChangeEl = document.getElementById('mcap-change');
                mcapChangeEl.textContent = `${mcapChange >= 0 ? '+' : ''}${mcapChange.toFixed(2)}%`;
                mcapChangeEl.className = `stat-change ${mcapChange >= 0 ? 'pnl-positive' : 'pnl-negative'}`;
                
            } catch (e) {
                // Fallback: usar dados da Binance
                const change = priceChanges[currentOrderbookSymbol] || 0;
                document.getElementById('mcap-change').textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                document.getElementById('mcap-change').className = `stat-change ${change >= 0 ? 'pnl-positive' : 'pnl-negative'}`;
            }
        }

        async function fetchVolume() {
            try {
                const response = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${currentOrderbookSymbol}`);
                const data = await response.json();
                const vol = parseFloat(data.quoteVolume);
                const priceChange = parseFloat(data.priceChangePercent);
                
                // Volume
                if (vol > 1e9) {
                    document.getElementById('live-volume').textContent = `$${(vol / 1e9).toFixed(2)}B`;
                } else {
                    document.getElementById('live-volume').textContent = `$${(vol / 1e6).toFixed(2)}M`;
                }
                
                // Volume % change (usando price change como proxy)
                const volChangeEl = document.getElementById('volume-change');
                volChangeEl.textContent = `${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%`;
                volChangeEl.className = `stat-change ${priceChange >= 0 ? 'pnl-positive' : 'pnl-negative'}`;
                
            } catch (e) {
                console.error('Volume error');
            }
        }

        // ============================================
        // MOVING AVERAGES - Médias Móveis
        // ============================================
        async function fetchMovingAverages() {
            const symbol = currentOrderbookSymbol;
            const crypto = CRYPTO_DATABASE[symbol];
            
            try {
                // Buscar dados de klines (candlesticks) - 200 dias para calcular MA200
                const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=200`);
                const klines = await response.json();
                
                if (!klines || klines.length < 7) {
                    throw new Error('Dados insuficientes');
                }
                
                // Extrair preços de fechamento
                const closePrices = klines.map(k => parseFloat(k[4]));
                const currentPrice = closePrices[closePrices.length - 1];
                
                // Calcular MAs
                const calculateMA = (prices, period) => {
                    if (prices.length < period) return null;
                    const slice = prices.slice(-period);
                    return slice.reduce((a, b) => a + b, 0) / period;
                };
                
                const ma7 = calculateMA(closePrices, 7);
                const ma25 = calculateMA(closePrices, 25);
                const ma99 = calculateMA(closePrices, 99);
                const ma200 = closePrices.length >= 200 ? calculateMA(closePrices, 200) : null;
                
                // Formatar preço
                const formatMAPrice = (price) => {
                    if (!price) return '--';
                    if (price >= 1000) return `$${price.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                    if (price >= 1) return `$${price.toFixed(2)}`;
                    return `$${price.toFixed(6)}`;
                };
                
                // Determinar sinal (buy/sell/neutral)
                const getSignal = (ma) => {
                    if (!ma) return { class: 'neutral', text: '--' };
                    const diff = ((currentPrice - ma) / ma) * 100;
                    if (diff > 2) return { class: 'buy', text: '↑ ACIMA' };
                    if (diff < -2) return { class: 'sell', text: '↓ ABAIXO' };
                    return { class: 'neutral', text: '→ NEUTRO' };
                };
                
                // Atualizar UI
                document.getElementById('ma-7').textContent = formatMAPrice(ma7);
                document.getElementById('ma-25').textContent = formatMAPrice(ma25);
                document.getElementById('ma-99').textContent = formatMAPrice(ma99);
                document.getElementById('ma-200').textContent = formatMAPrice(ma200);
                
                const signal7 = getSignal(ma7);
                const signal25 = getSignal(ma25);
                const signal99 = getSignal(ma99);
                const signal200 = getSignal(ma200);
                
                document.getElementById('ma-7-signal').className = `ma-signal ${signal7.class}`;
                document.getElementById('ma-7-signal').textContent = signal7.text;
                document.getElementById('ma-25-signal').className = `ma-signal ${signal25.class}`;
                document.getElementById('ma-25-signal').textContent = signal25.text;
                document.getElementById('ma-99-signal').className = `ma-signal ${signal99.class}`;
                document.getElementById('ma-99-signal').textContent = signal99.text;
                document.getElementById('ma-200-signal').className = `ma-signal ${signal200.class}`;
                document.getElementById('ma-200-signal').textContent = signal200.text;
                
                // Resumo geral
                const signals = [signal7, signal25, signal99, signal200].filter(s => s.text !== '--');
                const buyCount = signals.filter(s => s.class === 'buy').length;
                const sellCount = signals.filter(s => s.class === 'sell').length;
                
                const summaryEl = document.getElementById('ma-summary');
                if (buyCount > sellCount) {
                    summaryEl.innerHTML = `<span style="color: var(--accent-green);"><i class="fas fa-arrow-trend-up"></i> TENDÊNCIA DE ALTA</span> - Preço acima de ${buyCount} de ${signals.length} MAs`;
                } else if (sellCount > buyCount) {
                    summaryEl.innerHTML = `<span style="color: var(--accent-red);"><i class="fas fa-arrow-trend-down"></i> TENDÊNCIA DE BAIXA</span> - Preço abaixo de ${sellCount} de ${signals.length} MAs`;
                } else {
                    summaryEl.innerHTML = `<span style="color: var(--accent-yellow);"><i class="fas fa-minus"></i> CONSOLIDAÇÃO</span> - Preço próximo das médias`;
                }
                
            } catch (e) {
                console.error('MA error:', e);
                document.getElementById('ma-summary').innerHTML = '<span style="color: var(--text-muted);">Não foi possível calcular</span>';
            }
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.currentTarget.classList.add('active');
            
            if (sectionId === 'news') fetchNews();
            if (sectionId === 'macro') loadMacroData();
            if (sectionId === 'analysis') {
                fetchOrderBook();
                fetchFearGreed();
                fetchVolume();
                fetchCryptoStats();
                fetchMovingAverages();
            }
        }

        // Analysis Tab Switcher
        function switchAnalysisTab(tab) {
            document.querySelectorAll('.analysis-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.analysis-panel').forEach(p => p.classList.remove('active'));
            
            event.currentTarget.classList.add('active');
            document.getElementById(`panel-${tab}`).classList.add('active');
        }

        // ============================================
        // MACRO SECTION - Dados Macroeconômicos
        // ============================================
        
        // Macro Tab Switcher
        function switchMacroTab(tab) {
            document.querySelectorAll('.macro-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.macro-panel').forEach(p => p.classList.remove('active'));
            
            event.currentTarget.classList.add('active');
            document.getElementById(`panel-${tab}`).classList.add('active');
        }

        // FOMC Meeting Dates 2025-2026
        const FOMC_MEETINGS = [
            { date: '2025-01-29', label: '28-29 Jan 2025' },
            { date: '2025-03-19', label: '18-19 Mar 2025' },
            { date: '2025-05-07', label: '6-7 Mai 2025' },
            { date: '2025-06-18', label: '17-18 Jun 2025' },
            { date: '2025-07-30', label: '29-30 Jul 2025' },
            { date: '2025-09-17', label: '16-17 Set 2025' },
            { date: '2025-11-05', label: '4-5 Nov 2025' },
            { date: '2025-12-17', label: '16-17 Dez 2025' },
            { date: '2026-01-28', label: '27-28 Jan 2026' },
            { date: '2026-03-18', label: '17-18 Mar 2026' },
            { date: '2026-05-06', label: '5-6 Mai 2026' },
            { date: '2026-06-17', label: '16-17 Jun 2026' },
            { date: '2026-07-29', label: '28-29 Jul 2026' },
            { date: '2026-09-16', label: '15-16 Set 2026' },
            { date: '2026-11-04', label: '3-4 Nov 2026' },
            { date: '2026-12-16', label: '15-16 Dez 2026' }
        ];

        function getNextFOMCMeeting() {
            const today = new Date();
            for (const meeting of FOMC_MEETINGS) {
                const meetingDate = new Date(meeting.date);
                if (meetingDate > today) {
                    const diffTime = meetingDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return { ...meeting, daysUntil: diffDays };
                }
            }
            return null;
        }

        async function fetchFedWatchData() {
            const container = document.getElementById('fed-probabilities');
            const nextMeetingEl = document.getElementById('next-fomc-meeting');
            
            // Atualizar próxima reunião
            const nextMeeting = getNextFOMCMeeting();
            if (nextMeeting) {
                nextMeetingEl.innerHTML = `Próxima reunião FOMC: <strong>${nextMeeting.label}</strong> (${nextMeeting.daysUntil} dias)`;
            }
            
            // Buscar dados do Fear & Greed e outros indicadores para estimar probabilidades
            // Na prática, usaríamos a CME FedWatch API, mas ela é paga
            // Vamos usar uma estimativa baseada em dados de mercado
            
            try {
                // Buscar dados de mercado para estimar
                const [fgResponse, btcResponse] = await Promise.all([
                    fetch('https://api.alternative.me/fng/').then(r => r.json()).catch(() => null),
                    fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT').then(r => r.json()).catch(() => null)
                ]);
                
                // Lógica de estimativa baseada em condições de mercado
                // Em um cenário real, isso viria da CME
                let cutProb = 45;
                let holdProb = 50;
                let hikeProb = 5;
                
                // Ajustar baseado em Fear & Greed (mercado com medo = mais chance de corte)
                if (fgResponse && fgResponse.data && fgResponse.data[0]) {
                    const fgValue = parseInt(fgResponse.data[0].value);
                    if (fgValue < 30) {
                        cutProb += 15;
                        holdProb -= 10;
                        hikeProb -= 5;
                    } else if (fgValue > 70) {
                        cutProb -= 10;
                        holdProb += 5;
                        hikeProb += 5;
                    }
                }
                
                // Ajustar baseado em movimento do BTC (proxy para risk appetite)
                if (btcResponse) {
                    const btcChange = parseFloat(btcResponse.priceChangePercent);
                    if (btcChange < -5) {
                        cutProb += 10;
                        holdProb -= 5;
                        hikeProb -= 5;
                    } else if (btcChange > 5) {
                        cutProb -= 5;
                        holdProb += 5;
                    }
                }
                
                // Normalizar para 100%
                const total = cutProb + holdProb + hikeProb;
                cutProb = Math.round((cutProb / total) * 100);
                holdProb = Math.round((holdProb / total) * 100);
                hikeProb = 100 - cutProb - holdProb;
                
                container.innerHTML = `
                    <div class="fed-prob-item">
                        <div class="fed-prob-header">
                            <span class="fed-prob-action cut"><i class="fas fa-arrow-down"></i> Corte de Juros</span>
                            <span class="fed-prob-percent pnl-positive">${cutProb}%</span>
                        </div>
                        <div class="fed-prob-bar">
                            <div class="fed-prob-fill cut" style="width: ${cutProb}%"></div>
                        </div>
                    </div>
                    <div class="fed-prob-item">
                        <div class="fed-prob-header">
                            <span class="fed-prob-action hold"><i class="fas fa-equals"></i> Manutenção</span>
                            <span class="fed-prob-percent" style="color: var(--accent-yellow);">${holdProb}%</span>
                        </div>
                        <div class="fed-prob-bar">
                            <div class="fed-prob-fill hold" style="width: ${holdProb}%"></div>
                        </div>
                    </div>
                    <div class="fed-prob-item">
                        <div class="fed-prob-header">
                            <span class="fed-prob-action hike"><i class="fas fa-arrow-up"></i> Aumento de Juros</span>
                            <span class="fed-prob-percent pnl-negative">${hikeProb}%</span>
                        </div>
                        <div class="fed-prob-bar">
                            <div class="fed-prob-fill hike" style="width: ${hikeProb}%"></div>
                        </div>
                    </div>
                    <p style="font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 12px;">
                        <i class="fas fa-info-circle"></i> Estimativa baseada em indicadores de mercado
                    </p>
                `;
                
            } catch (e) {
                console.error('Fed Watch error:', e);
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Erro ao carregar dados</p>';
            }
        }

        // ============================================
        // EVENT DETAIL MODAL
        // ============================================
        const eventDetailsDatabase = {
            'Non-Farm Payrolls': {
                fullDescription: 'O relatório Non-Farm Payrolls (NFP) mede a variação no número de pessoas empregadas nos EUA, excluindo trabalhadores rurais, funcionários do governo, empregados domésticos e funcionários de ONGs.',
                marketImpact: 'Dados acima do esperado indicam economia forte, o que pode levar o Fed a manter ou aumentar juros. Dados abaixo do esperado sugerem desaceleração econômica, aumentando chances de cortes de juros.',
                cryptoImpact: 'NFP forte geralmente pressiona cripto negativamente no curto prazo (expectativa de juros altos). NFP fraco pode impulsionar cripto como alternativa ao dólar.'
            },
            'CPI (Inflação)': {
                fullDescription: 'O Consumer Price Index (CPI) mede a variação média dos preços pagos pelos consumidores por uma cesta de bens e serviços. É o principal indicador de inflação nos EUA.',
                marketImpact: 'Inflação acima do esperado aumenta a probabilidade de juros altos por mais tempo. Inflação em queda abre espaço para cortes de juros e estimula ativos de risco.',
                cryptoImpact: 'Alta inflação historicamente beneficia Bitcoin como hedge. Porém, se a inflação forçar juros altos, há pressão negativa no curto prazo sobre cripto.'
            },
            'PPI (Preços ao Produtor)': {
                fullDescription: 'O Producer Price Index (PPI) mede a variação média dos preços recebidos pelos produtores domésticos por sua produção. É um indicador antecedente da inflação ao consumidor.',
                marketImpact: 'PPI é visto como preview do CPI. Aumento forte no PPI indica que a inflação pode subir, afetando decisões do Fed sobre juros.',
                cryptoImpact: 'Impacto similar ao CPI, mas geralmente mais moderado. Serve como sinal de alerta para movimentos futuros em cripto.'
            },
            'Retail Sales': {
                fullDescription: 'O relatório de Retail Sales mede o valor total das vendas no varejo nos EUA. É um indicador chave da saúde do consumidor e da economia.',
                marketImpact: 'Vendas fortes indicam economia resiliente, o que pode prolongar ciclo de juros altos. Vendas fracas sugerem desaceleração e possível recessão.',
                cryptoImpact: 'Dados de varejo fortes geralmente são bearish para cripto (mantém juros altos). Dados fracos podem ser bullish se indicarem cortes de juros próximos.'
            },
            'Decisão FOMC': {
                fullDescription: 'A reunião do Federal Open Market Committee (FOMC) decide a taxa de juros básica dos EUA. O comunicado e a coletiva do Fed Chair fornecem guidance sobre política monetária futura.',
                marketImpact: 'É o evento mais importante para mercados financeiros. Mudanças na taxa ou no tom do comunicado podem causar movimentos extremos em todos os ativos.',
                cryptoImpact: 'Cortes de juros são extremamente bullish para cripto. Aumentos ou tom hawkish são bearish. A volatilidade é máxima durante e após o anúncio.'
            },
            'PIB Q4 2025': {
                fullDescription: 'O Produto Interno Bruto (PIB) mede o valor total de bens e serviços produzidos na economia. O dado trimestral é crucial para avaliar o ritmo de crescimento econômico.',
                marketImpact: 'PIB forte sugere economia saudável, mas pode indicar pressão inflacionária. PIB fraco levanta preocupações de recessão, mas pode acelerar cortes de juros.',
                cryptoImpact: 'PIB muito forte pode ser bearish (juros altos). PIB em desaceleração moderada pode ser bullish se acelerar expectativas de cortes.'
            },
            'ISM Services': {
                fullDescription: 'O ISM Services Index mede a atividade no setor de serviços, que representa mais de 70% da economia americana. Leitura acima de 50 indica expansão.',
                marketImpact: 'Setor de serviços forte mantém inflação alta (especialmente salários). Desaceleração pode indicar economia esfriando.',
                cryptoImpact: 'Impacto moderado. ISM muito forte é levemente bearish para cripto. ISM fraco pode ser levemente bullish.'
            },
            'Decisão BCE': {
                fullDescription: 'O Banco Central Europeu (BCE) decide a taxa de juros para a Zona do Euro. A política monetária europeia afeta mercados globais e a relação EUR/USD.',
                marketImpact: 'Divergência entre políticas do Fed e BCE afeta câmbio. BCE dovish fortalece dólar. BCE hawkish enfraquece dólar.',
                cryptoImpact: 'Impacto indireto via dólar. BCE dovish (dólar forte) pode pressionar cripto. BCE hawkish (dólar fraco) pode beneficiar cripto.'
            }
        };

        function openEventDetailModal(event) {
            const modal = document.getElementById('event-detail-modal');
            const details = eventDetailsDatabase[event.title] || {
                fullDescription: event.description,
                marketImpact: 'Dados econômicos importantes que podem afetar a política monetária e os mercados financeiros.',
                cryptoImpact: 'O impacto em criptomoedas depende de como o mercado interpreta os dados em relação às expectativas.'
            };
            
            // Preencher dados
            document.querySelector('#event-detail-date .event-detail-day').textContent = event.day;
            document.querySelector('#event-detail-date .event-detail-month').textContent = event.month;
            document.getElementById('event-detail-title').textContent = event.title;
            document.getElementById('event-detail-country').textContent = `${event.country} • ${event.description}`;
            
            const impactEl = document.getElementById('event-detail-impact');
            impactEl.textContent = event.impact === 'high' ? 'IMPACTO ALTO' : event.impact === 'medium' ? 'IMPACTO MÉDIO' : 'IMPACTO BAIXO';
            impactEl.className = `event-detail-impact ${event.impact}`;
            
            document.getElementById('event-detail-description').textContent = details.fullDescription;
            document.getElementById('event-detail-market-impact').textContent = details.marketImpact;
            document.getElementById('event-detail-crypto-impact').textContent = details.cryptoImpact;
            
            // Mostrar modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Adicionar ao histórico para suportar botão voltar
            if (window.history && window.history.pushState) {
                window.history.pushState({ page: 'event-detail' }, '', '');
            }
        }

        function closeEventDetailModal() {
            document.getElementById('event-detail-modal').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function fetchEconomicCalendar() {
            const container = document.getElementById('economic-calendar');
            
            // Eventos econômicos importantes - dados estáticos atualizados
            // Em produção, usaríamos uma API como Trading Economics ou Investing.com
            const today = new Date();
            const events = [
                { day: 10, month: 'JAN', title: 'Non-Farm Payrolls', country: '🇺🇸 EUA', impact: 'high', description: 'Relatório de emprego' },
                { day: 14, month: 'JAN', title: 'CPI (Inflação)', country: '🇺🇸 EUA', impact: 'high', description: 'Índice de preços ao consumidor' },
                { day: 15, month: 'JAN', title: 'PPI (Preços ao Produtor)', country: '🇺🇸 EUA', impact: 'medium', description: 'Inflação no atacado' },
                { day: 16, month: 'JAN', title: 'Retail Sales', country: '🇺🇸 EUA', impact: 'medium', description: 'Vendas no varejo' },
                { day: 29, month: 'JAN', title: 'Decisão FOMC', country: '🇺🇸 EUA', impact: 'high', description: 'Taxa de juros Fed' },
                { day: 30, month: 'JAN', title: 'PIB Q4 2025', country: '🇺🇸 EUA', impact: 'high', description: 'Crescimento econômico' },
                { day: 3, month: 'FEV', title: 'ISM Services', country: '🇺🇸 EUA', impact: 'medium', description: 'Setor de serviços' },
                { day: 7, month: 'FEV', title: 'Non-Farm Payrolls', country: '🇺🇸 EUA', impact: 'high', description: 'Relatório de emprego' },
                { day: 12, month: 'FEV', title: 'CPI (Inflação)', country: '🇺🇸 EUA', impact: 'high', description: 'Índice de preços ao consumidor' },
                { day: 6, month: 'MAR', title: 'Decisão BCE', country: '🇪🇺 Europa', impact: 'high', description: 'Taxa de juros BCE' },
                { day: 19, month: 'MAR', title: 'Decisão FOMC', country: '🇺🇸 EUA', impact: 'high', description: 'Taxa de juros Fed' }
            ];
            
            // Salvar eventos globalmente para uso no onclick
            window.economicEvents = events;
            
            container.innerHTML = events.map((event, index) => `
                <div class="calendar-event" onclick="openEventDetailModal(window.economicEvents[${index}])">
                    <div class="calendar-date">
                        <div class="calendar-day">${event.day}</div>
                        <div class="calendar-month">${event.month}</div>
                    </div>
                    <div class="calendar-info">
                        <div class="calendar-title">${event.title}</div>
                        <div class="calendar-country">${event.country} • ${event.description}</div>
                    </div>
                    <div class="calendar-impact ${event.impact}">${event.impact === 'high' ? 'ALTO' : event.impact === 'medium' ? 'MÉDIO' : 'BAIXO'}</div>
                </div>
            `).join('');
        }

        async function fetchMarketIndicators() {
            const container = document.getElementById('market-indicators');
            
            try {
                // Buscar dados de várias fontes
                const indicators = [];
                
                // VIX - Fear Index (usando proxy/estimativa)
                // S&P 500, DXY, Gold, Oil via diferentes APIs
                
                // Buscar S&P 500 futures via Yahoo Finance proxy
                try {
                    const sp500Data = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/%5EGSPC?interval=1d&range=2d')
                        .then(r => r.json())
                        .catch(() => null);
                    
                    if (sp500Data?.chart?.result?.[0]) {
                        const result = sp500Data.chart.result[0];
                        const closes = result.indicators.quote[0].close;
                        const currentPrice = closes[closes.length - 1];
                        const prevPrice = closes[closes.length - 2] || currentPrice;
                        const change = ((currentPrice - prevPrice) / prevPrice) * 100;
                        
                        indicators.push({
                            name: 'S&P 500',
                            desc: 'Índice americano',
                            icon: 'sp500',
                            iconClass: 'fas fa-chart-line',
                            value: currentPrice.toFixed(2),
                            change: change
                        });
                    }
                } catch (e) {
                    indicators.push({
                        name: 'S&P 500',
                        desc: 'Índice americano',
                        icon: 'sp500',
                        iconClass: 'fas fa-chart-line',
                        value: '5,950.25',
                        change: 0.45
                    });
                }
                
                // DXY - Dollar Index
                try {
                    const dxyData = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/DX-Y.NYB?interval=1d&range=2d')
                        .then(r => r.json())
                        .catch(() => null);
                    
                    if (dxyData?.chart?.result?.[0]) {
                        const result = dxyData.chart.result[0];
                        const closes = result.indicators.quote[0].close;
                        const currentPrice = closes[closes.length - 1];
                        const prevPrice = closes[closes.length - 2] || currentPrice;
                        const change = ((currentPrice - prevPrice) / prevPrice) * 100;
                        
                        indicators.push({
                            name: 'DXY',
                            desc: 'Índice do Dólar',
                            icon: 'dxy',
                            iconClass: 'fas fa-dollar-sign',
                            value: currentPrice.toFixed(2),
                            change: change
                        });
                    }
                } catch (e) {
                    indicators.push({
                        name: 'DXY',
                        desc: 'Índice do Dólar',
                        icon: 'dxy',
                        iconClass: 'fas fa-dollar-sign',
                        value: '104.25',
                        change: -0.15
                    });
                }
                
                // VIX - Volatility Index
                try {
                    const vixData = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/%5EVIX?interval=1d&range=2d')
                        .then(r => r.json())
                        .catch(() => null);
                    
                    if (vixData?.chart?.result?.[0]) {
                        const result = vixData.chart.result[0];
                        const closes = result.indicators.quote[0].close;
                        const currentPrice = closes[closes.length - 1];
                        const prevPrice = closes[closes.length - 2] || currentPrice;
                        const change = ((currentPrice - prevPrice) / prevPrice) * 100;
                        
                        indicators.push({
                            name: 'VIX',
                            desc: 'Índice de Volatilidade',
                            icon: 'vix',
                            iconClass: 'fas fa-bolt',
                            value: currentPrice.toFixed(2),
                            change: change
                        });
                    }
                } catch (e) {
                    indicators.push({
                        name: 'VIX',
                        desc: 'Índice de Volatilidade',
                        icon: 'vix',
                        iconClass: 'fas fa-bolt',
                        value: '15.45',
                        change: 2.5
                    });
                }
                
                // Gold
                try {
                    const goldData = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/GC=F?interval=1d&range=2d')
                        .then(r => r.json())
                        .catch(() => null);
                    
                    if (goldData?.chart?.result?.[0]) {
                        const result = goldData.chart.result[0];
                        const closes = result.indicators.quote[0].close;
                        const currentPrice = closes[closes.length - 1];
                        const prevPrice = closes[closes.length - 2] || currentPrice;
                        const change = ((currentPrice - prevPrice) / prevPrice) * 100;
                        
                        indicators.push({
                            name: 'Ouro',
                            desc: 'XAU/USD',
                            icon: 'gold',
                            iconClass: 'fas fa-coins',
                            value: '$' + currentPrice.toFixed(2),
                            change: change
                        });
                    }
                } catch (e) {
                    indicators.push({
                        name: 'Ouro',
                        desc: 'XAU/USD',
                        icon: 'gold',
                        iconClass: 'fas fa-coins',
                        value: '$2,650.30',
                        change: 0.35
                    });
                }
                
                // Oil
                try {
                    const oilData = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/CL=F?interval=1d&range=2d')
                        .then(r => r.json())
                        .catch(() => null);
                    
                    if (oilData?.chart?.result?.[0]) {
                        const result = oilData.chart.result[0];
                        const closes = result.indicators.quote[0].close;
                        const currentPrice = closes[closes.length - 1];
                        const prevPrice = closes[closes.length - 2] || currentPrice;
                        const change = ((currentPrice - prevPrice) / prevPrice) * 100;
                        
                        indicators.push({
                            name: 'Petróleo WTI',
                            desc: 'Crude Oil',
                            icon: 'oil',
                            iconClass: 'fas fa-oil-can',
                            value: '$' + currentPrice.toFixed(2),
                            change: change
                        });
                    }
                } catch (e) {
                    indicators.push({
                        name: 'Petróleo WTI',
                        desc: 'Crude Oil',
                        icon: 'oil',
                        iconClass: 'fas fa-oil-can',
                        value: '$73.50',
                        change: -1.2
                    });
                }
                
                // Se não conseguiu nenhum dado, usar fallback
                if (indicators.length === 0) {
                    indicators.push(
                        { name: 'S&P 500', desc: 'Índice americano', icon: 'sp500', iconClass: 'fas fa-chart-line', value: '5,950.25', change: 0.45 },
                        { name: 'DXY', desc: 'Índice do Dólar', icon: 'dxy', iconClass: 'fas fa-dollar-sign', value: '104.25', change: -0.15 },
                        { name: 'VIX', desc: 'Índice de Volatilidade', icon: 'vix', iconClass: 'fas fa-bolt', value: '15.45', change: 2.5 },
                        { name: 'Ouro', desc: 'XAU/USD', icon: 'gold', iconClass: 'fas fa-coins', value: '$2,650.30', change: 0.35 },
                        { name: 'Petróleo WTI', desc: 'Crude Oil', icon: 'oil', iconClass: 'fas fa-oil-can', value: '$73.50', change: -1.2 }
                    );
                }
                
                container.innerHTML = indicators.map(ind => `
                    <div class="market-indicator">
                        <div class="indicator-info">
                            <div class="indicator-icon ${ind.icon}">
                                <i class="${ind.iconClass}"></i>
                            </div>
                            <div>
                                <div class="indicator-name">${ind.name}</div>
                                <div class="indicator-desc">${ind.desc}</div>
                            </div>
                        </div>
                        <div class="indicator-value">
                            <div class="indicator-price">${ind.value}</div>
                            <div class="indicator-change ${ind.change >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${ind.change >= 0 ? '+' : ''}${ind.change.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (e) {
                console.error('Market indicators error:', e);
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Erro ao carregar indicadores</p>';
            }
        }

        function loadMacroData() {
            fetchFedWatchData();
            fetchEconomicCalendar();
            fetchMarketIndicators();
        }

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            connectPriceStream();
            
            // AI update every 2s
            setInterval(updateAIRecommendation, 2000);
            
            // Order Book every 2s
            setInterval(fetchOrderBook, 2000);
            
            // News every 30 seconds (real-time)
            setInterval(fetchNews, 30000);
            
            // Fear & Greed every 60s
            setInterval(fetchFearGreed, 60000);
            
            // Global data every 60s
            setInterval(fetchGlobalData, 60000);
            
            // Volume every 5s
            setInterval(fetchVolume, 5000);
            
            // Crypto stats every 30s
            setInterval(fetchCryptoStats, 30000);
            
            // Moving Averages every 10s
            setInterval(fetchMovingAverages, 10000);
            
            // Initial load
            setTimeout(() => {
                renderAllPrices();
                updateAIRecommendation();
                fetchNews();
                fetchFearGreed();
                fetchGlobalData();
                fetchOrderBook();
                fetchVolume();
                fetchCryptoStats();
                fetchMovingAverages();
                renderDropdownMenu();
            }, 1000);
        });

        console.log('🚀 Visor Crypto - Real-Time');

        // ============================================
        // CHART MODAL - Gráfico de Preços
        // ============================================
        let currentChartSymbol = null;
        let currentChartPeriod = '1m';
        let currentChartType = 'line';
        let chartInstance = null;
        let candleData = null;
        let chartRefreshInterval = null; // Intervalo para atualização em tempo real

        async function openChartModal(symbol) {
            currentChartSymbol = symbol;
            const crypto = CRYPTO_DATABASE[symbol];
            
            // Atualizar header do modal
            document.getElementById('chart-crypto-icon').src = crypto.img;
            document.getElementById('chart-crypto-name').textContent = crypto.name;
            
            const price = prices[symbol] || 0;
            const change = priceChanges[symbol] || 0;
            document.getElementById('chart-crypto-price').innerHTML = `$${price.toLocaleString(undefined, {minimumFractionDigits: 2})} <span class="${change >= 0 ? 'pnl-positive' : 'pnl-negative'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>`;
            
            // Mostrar modal
            document.getElementById('chart-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Reset filtro para 1m
            currentChartPeriod = '1m';
            currentChartType = 'line';
            document.querySelectorAll('.chart-period-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.chart-period-btn[data-period="1m"]').classList.add('active');
            document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.chart-type-btn[data-type="line"]').classList.add('active');
            
            // Carregar dados
            await loadChartData();
            
            // Iniciar atualização em tempo real
            startChartRealTimeUpdate();
        }

        function closeChartModal() {
            document.getElementById('chart-modal').classList.remove('active');
            document.body.style.overflow = '';
            currentChartSymbol = null;
            candleData = null;
            
            // Parar atualização em tempo real
            if (chartRefreshInterval) {
                clearInterval(chartRefreshInterval);
                chartRefreshInterval = null;
            }
            
            // Destruir gráfico
            if (chartInstance) {
                chartInstance = null;
            }
        }
        
        // Função para iniciar atualização em tempo real do gráfico
        function startChartRealTimeUpdate() {
            // Parar intervalo anterior se existir
            if (chartRefreshInterval) {
                clearInterval(chartRefreshInterval);
            }
            
            // Definir intervalo de atualização baseado no período selecionado
            // Períodos menores atualizam mais frequentemente
            const refreshRates = {
                '1m': 5000,    // 5 segundos
                '5m': 10000,   // 10 segundos
                '30m': 30000,  // 30 segundos
                '1h': 60000,   // 1 minuto
                '4h': 120000,  // 2 minutos
                '24h': 300000, // 5 minutos
                '7d': 300000,  // 5 minutos
                '30d': 600000  // 10 minutos
            };
            
            const refreshRate = refreshRates[currentChartPeriod] || 10000;
            
            chartRefreshInterval = setInterval(async () => {
                if (currentChartSymbol && document.getElementById('chart-modal').classList.contains('active')) {
                    await loadChartData();
                    console.log('📊 Gráfico atualizado em tempo real');
                }
            }, refreshRate);
        }

        async function changeChartPeriod(period) {
            currentChartPeriod = period;
            
            // Atualizar botões
            document.querySelectorAll('.chart-period-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.chart-period-btn[data-period="${period}"]`).classList.add('active');
            
            await loadChartData();
            
            // Reiniciar atualização em tempo real com nova taxa
            startChartRealTimeUpdate();
        }

        function changeChartType(type) {
            currentChartType = type;
            
            // Atualizar botões
            document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.chart-type-btn[data-type="${type}"]`).classList.add('active');
            
            // Redesenhar com dados existentes
            if (candleData) {
                if (type === 'candle') {
                    drawCandleChart(candleData);
                } else {
                    const prices = candleData.map(k => [k[0], k[4]]);
                    drawChart(prices, null);
                }
            }
        }

        async function loadChartData() {
            if (!currentChartSymbol) return;
            
            const loadingEl = document.getElementById('chart-loading');
            const canvas = document.getElementById('price-chart');
            
            loadingEl.style.display = 'flex';
            canvas.style.opacity = '0.3';
            
            try {
                // Mapear período para intervalo Binance
                const periodMap = {
                    '1m': { interval: '1m', limit: 120 },
                    '5m': { interval: '5m', limit: 100 },
                    '30m': { interval: '30m', limit: 100 },
                    '1h': { interval: '1h', limit: 100 },
                    '4h': { interval: '4h', limit: 100 },
                    '24h': { interval: '1d', limit: 30 },
                    '7d': { interval: '4h', limit: 42 },   // 7 dias x 6 candles de 4h por dia
                    '30d': { interval: '1d', limit: 30 }   // 30 dias
                };
                
                const config = periodMap[currentChartPeriod] || periodMap['1m'];
                
                const binanceRes = await fetch(`https://api.binance.com/api/v3/klines?symbol=${currentChartSymbol}&interval=${config.interval}&limit=${config.limit}`);
                const klines = await binanceRes.json();
                
                if (klines && klines.length > 0) {
                    // Guardar dados para alternar entre tipos
                    candleData = klines.map(k => [
                        k[0],                    // timestamp
                        parseFloat(k[1]),        // open
                        parseFloat(k[2]),        // high
                        parseFloat(k[3]),        // low
                        parseFloat(k[4]),        // close
                        parseFloat(k[5])         // volume
                    ]);
                    
                    if (currentChartType === 'candle') {
                        drawCandleChart(candleData);
                    } else {
                        const prices = candleData.map(k => [k[0], k[4]]);
                        drawChart(prices, null);
                    }
                    updateChartStats(candleData.map(k => [k[0], k[4]]));
                }
            } catch (e) {
                console.error('Chart error:', e);
            }
            
            loadingEl.style.display = 'none';
            canvas.style.opacity = '1';
        }

        function drawCandleChart(candleData) {
            const canvas = document.getElementById('price-chart');
            const ctx = canvas.getContext('2d');
            
            // Ajustar canvas para DPI da tela
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            
            const width = rect.width;
            const height = rect.height;
            const padding = { top: 20, right: 10, bottom: 30, left: 60 };
            
            // Limpar canvas
            ctx.clearRect(0, 0, width, height);
            
            // Encontrar min/max
            let minPrice = Infinity, maxPrice = -Infinity;
            candleData.forEach(c => {
                minPrice = Math.min(minPrice, c[3]); // low
                maxPrice = Math.max(maxPrice, c[2]); // high
            });
            const priceRange = maxPrice - minPrice || 1;
            
            // Área do gráfico
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // Desenhar linhas de grade horizontais
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                
                // Labels de preço
                const price = maxPrice - (priceRange / 4) * i;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.font = '10px Inter';
                ctx.textAlign = 'right';
                ctx.fillText(formatChartPrice(price), padding.left - 8, y + 4);
            }
            
            // Calcular largura das velas
            const candleWidth = Math.max(2, (chartWidth / candleData.length) * 0.7);
            const candleSpacing = chartWidth / candleData.length;
            
            // Desenhar velas
            candleData.forEach((candle, i) => {
                const [timestamp, open, high, low, close] = candle;
                const isGreen = close >= open;
                const color = isGreen ? '#22c55e' : '#ef4444';
                
                const x = padding.left + i * candleSpacing + candleSpacing / 2;
                const openY = padding.top + (1 - (open - minPrice) / priceRange) * chartHeight;
                const closeY = padding.top + (1 - (close - minPrice) / priceRange) * chartHeight;
                const highY = padding.top + (1 - (high - minPrice) / priceRange) * chartHeight;
                const lowY = padding.top + (1 - (low - minPrice) / priceRange) * chartHeight;
                
                // Desenhar pavio
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, highY);
                ctx.lineTo(x, lowY);
                ctx.stroke();
                
                // Desenhar corpo
                const bodyTop = Math.min(openY, closeY);
                const bodyHeight = Math.abs(closeY - openY) || 1;
                
                ctx.fillStyle = color;
                ctx.fillRect(x - candleWidth / 2, bodyTop, candleWidth, bodyHeight);
            });
        }

        function drawChart(priceData, volumeData) {
            const canvas = document.getElementById('price-chart');
            const ctx = canvas.getContext('2d');
            
            // Ajustar canvas para DPI da tela
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            
            const width = rect.width;
            const height = rect.height;
            const padding = { top: 20, right: 10, bottom: 30, left: 60 };
            
            // Limpar canvas
            ctx.clearRect(0, 0, width, height);
            
            // Extrair preços
            const prices = priceData.map(p => p[1]);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const priceRange = maxPrice - minPrice || 1;
            
            // Área do gráfico
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // Determinar cor baseado em tendência
            const isUp = prices[prices.length - 1] >= prices[0];
            const lineColor = isUp ? '#22c55e' : '#ef4444';
            const gradientColor = isUp ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';
            
            // Desenhar linhas de grade horizontais
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                
                // Labels de preço
                const price = maxPrice - (priceRange / 4) * i;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.font = '10px Inter';
                ctx.textAlign = 'right';
                ctx.fillText(formatChartPrice(price), padding.left - 8, y + 4);
            }
            
            // Calcular pontos
            const points = prices.map((price, i) => ({
                x: padding.left + (i / (prices.length - 1)) * chartWidth,
                y: padding.top + (1 - (price - minPrice) / priceRange) * chartHeight
            }));
            
            // Desenhar área preenchida
            ctx.beginPath();
            ctx.moveTo(points[0].x, height - padding.bottom);
            points.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.lineTo(points[points.length - 1].x, height - padding.bottom);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(0, padding.top, 0, height - padding.bottom);
            gradient.addColorStop(0, gradientColor);
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // Desenhar linha
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            points.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            
            // Ponto final com glow
            const lastPoint = points[points.length - 1];
            ctx.beginPath();
            ctx.arc(lastPoint.x, lastPoint.y, 6, 0, Math.PI * 2);
            ctx.fillStyle = lineColor;
            ctx.fill();
            ctx.shadowColor = lineColor;
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.arc(lastPoint.x, lastPoint.y, 4, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function formatChartPrice(price) {
            if (price >= 1000) return `$${(price/1000).toFixed(1)}k`;
            if (price >= 1) return `$${price.toFixed(2)}`;
            if (price >= 0.01) return `$${price.toFixed(4)}`;
            return `$${price.toFixed(8)}`;
        }

        function updateChartStats(priceData) {
            const prices = priceData.map(p => p[1]);
            const firstPrice = prices[0];
            const lastPrice = prices[prices.length - 1];
            const highPrice = Math.max(...prices);
            const lowPrice = Math.min(...prices);
            const changePercent = ((lastPrice - firstPrice) / firstPrice) * 100;
            
            document.getElementById('chart-high').textContent = formatChartPrice(highPrice);
            document.getElementById('chart-low').textContent = formatChartPrice(lowPrice);
            
            const changeEl = document.getElementById('chart-change');
            changeEl.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
            changeEl.className = `chart-stat-value ${changePercent >= 0 ? 'pnl-positive' : 'pnl-negative'}`;
            
            // Volume (pegar do Binance)
            if (currentChartSymbol) {
                fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${currentChartSymbol}`)
                    .then(r => r.json())
                    .then(data => {
                        const vol = parseFloat(data.quoteVolume);
                        document.getElementById('chart-volume').textContent = vol > 1e9 ? `$${(vol/1e9).toFixed(2)}B` : `$${(vol/1e6).toFixed(2)}M`;
                    })
                    .catch(() => {
                        document.getElementById('chart-volume').textContent = '--';
                    });
            }
        }

        // ============================================
        // ANDROID BACK BUTTON HANDLER
        // ============================================
        let navigationHistory = ['home'];
        let lastBackPressTime = 0;

        function pushNavigation(page) {
            if (navigationHistory[navigationHistory.length - 1] !== page) {
                navigationHistory.push(page);
                // Adicionar ao histórico do navegador para suportar gesto de swipe
                if (window.history && window.history.pushState) {
                    window.history.pushState({ page: page }, '', '');
                }
            }
        }

        function handleBackButton() {
            // Se modal de evento econômico está aberto, fechar
            const eventModal = document.getElementById('event-detail-modal');
            if (eventModal && eventModal.classList.contains('active')) {
                closeEventDetailModal();
                return true;
            }
            
            // Se modal de gráfico está aberto, fechar
            if (document.getElementById('chart-modal').classList.contains('active')) {
                closeChartModal();
                return true;
            }
            
            // Se modal de notícia está aberto, fechar
            if (document.getElementById('news-modal').classList.contains('active')) {
                closeNewsModal();
                return true;
            }
            
            // Se não está na home, voltar para seção anterior
            if (navigationHistory.length > 1) {
                navigationHistory.pop(); // Remove atual
                const previousPage = navigationHistory[navigationHistory.length - 1];
                showSectionDirect(previousPage);
                return true;
            }
            
            // Se já está na home, verificar qual seção está ativa
            const activeSection = document.querySelector('.section.active');
            if (activeSection && activeSection.id !== 'home') {
                // Voltar para home
                showSectionDirect('home');
                navigationHistory = ['home'];
                return true;
            }
            
            // Se já está na home, não fazer nada (NÃO fechar o app)
            // Apenas mostra feedback visual que já está na home
            console.log('📱 Já está na tela inicial');
            return true; // Sempre retorna true para NUNCA fechar o app
        }

        function showSectionDirect(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            // Ativar nav item correspondente
            document.querySelectorAll('.nav-item').forEach(nav => {
                if (nav.getAttribute('onclick')?.includes(sectionId)) {
                    nav.classList.add('active');
                }
            });
            
            if (sectionId === 'news') fetchNews();
            if (sectionId === 'macro') loadMacroData();
            if (sectionId === 'analysis') {
                fetchOrderBook();
                fetchFearGreed();
                fetchVolume();
                fetchCryptoStats();
                fetchMovingAverages();
            }
        }

        // Override showSection to track navigation
        const originalShowSection = showSection;
        showSection = function(sectionId) {
            pushNavigation(sectionId);
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.currentTarget.classList.add('active');
            
            if (sectionId === 'news') fetchNews();
            if (sectionId === 'macro') loadMacroData();
            if (sectionId === 'analysis') {
                fetchOrderBook();
                fetchFearGreed();
                fetchVolume();
                fetchCryptoStats();
                fetchMovingAverages();
            }
        };

        // Listener para botão voltar do Android (Capacitor)
        document.addEventListener('backbutton', function(e) {
            e.preventDefault();
            e.stopPropagation();
            window.backButtonHandled = handleBackButton();
        }, false);

        // Listener para o evento deviceready do Capacitor/Cordova
        document.addEventListener('deviceready', function() {
            document.addEventListener('backbutton', function(e) {
                e.preventDefault();
                e.stopPropagation();
                window.backButtonHandled = handleBackButton();
            }, false);
        }, false);
        
        // Listener para evento customizado do Android (MainActivity.java)
        document.addEventListener('androidBackButton', function(e) {
            e.preventDefault();
            window.backButtonHandled = handleBackButton();
            console.log('🔙 Android back button handled:', window.backButtonHandled);
        }, false);
        
        // Inicializar variável global
        window.backButtonHandled = true;

        // Fallback: popstate para navegadores (suporta swipe back)
        window.addEventListener('popstate', function(e) {
            e.preventDefault();
            const handled = handleBackButton();
            if (!handled) {
                // Se retornou false, re-adiciona o estado para não sair
                if (window.history && window.history.pushState) {
                    window.history.pushState({ page: 'home' }, '', '');
                }
            }
        });

        // Adicionar estado inicial ao histórico
        if (window.history && window.history.pushState) {
            // Limpar histórico e começar fresh
            window.history.replaceState({ page: 'home' }, '', '');
        }

        // Interceptar navegação para registrar histórico
        document.addEventListener('click', function(e) {
            // Ao clicar em links de navegação, adicionar ao histórico
            const navItem = e.target.closest('.nav-item');
            if (navItem && window.history && window.history.pushState) {
                window.history.pushState({ page: 'nav' }, '', '');
            }
            
            // Ao abrir gráfico, adicionar ao histórico
            const tickerItem = e.target.closest('.ticker-item');
            if (tickerItem && window.history && window.history.pushState) {
                window.history.pushState({ page: 'chart' }, '', '');
            }
            
            // Ao abrir notícia, adicionar ao histórico
            const newsItem = e.target.closest('.news-item');
            if (newsItem && window.history && window.history.pushState) {
                window.history.pushState({ page: 'news-detail' }, '', '');
            }
        });
        
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('✅ Service Worker registrado:', registration.scope);
                    })
                    .catch(error => {
                        console.log('❌ Erro ao registrar Service Worker:', error);
                    });
            });
        }
        
        // Detectar se é PWA instalado
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
            console.log('📱 Executando como PWA instalado');
        }
    </script>
</body>
</html>